Array.prototype.findIndex||(Array.prototype.findIndex=function(t){"use strict";if(null==this)throw new TypeError("Array.prototype.findIndex called on null or undefined");if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var e,s=Object(this),i=s.length>>>0,o=arguments[1],r=0;r<i;r++)if(e=s[r],t.call(o,e,r,s))return r;return-1}),function(){var t,e,s,i,o=0,r=["ms","moz","webkit","o"];for(t=0,e=r.length;t<e&&!window.requestAnimationFrame;++t)window.requestAnimationFrame=window[r[t]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[r[t]+"CancelAnimationFrame"]||window[r[t]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,e){return s=(new Date).getTime(),i=Math.max(0,16-(s-o)),o=s+i,window.setTimeout(function(){t(s+i)},i)}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}(),"function"!=typeof Object.assign&&(Object.assign=function(t){"use strict";if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var e=Object(t),s=1;s<arguments.length;s++){var i=arguments[s];if(null!=i)for(var o in i)i.hasOwnProperty(o)&&(e[o]=i[o])}return e}),Array.prototype.find||(Array.prototype.find=function(t){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var e,s=Object(this),i=s.length>>>0,o=arguments[1],r=0;r<i;r++)if(e=s[r],t.call(o,e,r,s))return e});var NSSketchpad={avaliableTools:[],defaultTool:"pen",watermarkTitle:"sketchpad.pro library is available under AGPL-3 license, visit http://developers.sketchpad.pro for source code. This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.",watermarkImageSrc:'data:image/svg+xml;utf8,<?xml version="1.0" encoding="UTF-8" standalone="no"?> <svg    xmlns:dc="http://purl.org/dc/elements/1.1/"    xmlns:cc="http://creativecommons.org/ns#"    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"    xmlns:svg="http://www.w3.org/2000/svg"    xmlns="http://www.w3.org/2000/svg"    xmlns:xlink="http://www.w3.org/1999/xlink"    xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"    xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"    width="128"    height="18"    viewBox="0 0 294.79549 53.369998"    id="svg2"    version="1.1"    inkscape:version="0.91 r13725"    sodipodi:docname="sketchpad-logo-clean.svg">   <sodipodi:namedview      pagecolor="#ffffff"      bordercolor="#666666"      borderopacity="1"      objecttolerance="10"      gridtolerance="10"      guidetolerance="10"      inkscape:pageopacity="0"      inkscape:pageshadow="2"      inkscape:window-width="1296"      inkscape:window-height="719"      id="namedview51"      showgrid="true"      inkscape:zoom="6.416994"      inkscape:cx="72.420486"      inkscape:cy="4.2725026"      inkscape:window-x="99"      inkscape:window-y="0"      inkscape:window-maximized="0"      inkscape:current-layer="layer1">     <inkscape:grid        type="xygrid"        id="grid3441" />   </sodipodi:namedview>   <defs      id="defs4">     <linearGradient        id="rainbow"        inkscape:collect="always">       <stop          offset="0"          style="stop-color:#ff0101;stop-opacity:1"          id="stop6" />       <stop          offset="0.04"          style="stop-color:#ff7901;stop-opacity:1"          id="stop8" />       <stop          offset="0.12"          style="stop-color:#fff001;stop-opacity:1"          id="stop10" />       <stop          offset="0.20"          style="stop-color:#96ff01;stop-opacity:1"          id="stop12" />       <stop          offset="0.27"          style="stop-color:#1fff01;stop-opacity:1"          id="stop14" />       <stop          offset="0.34"          style="stop-color:#01ff5b;stop-opacity:1"          id="stop16" />       <stop          offset="0.41"          style="stop-color:#01ffd2;stop-opacity:1"          id="stop18" />       <stop          offset="0.51"          style="stop-color:#01b4ff;stop-opacity:1"          id="stop20" />       <stop          offset="0.56"          style="stop-color:#013dff;stop-opacity:1"          id="stop22" />       <stop          offset="0.67"          style="stop-color:#3d01ff;stop-opacity:1"          id="stop24" />       <stop          offset="0.78"          style="stop-color:#b401ff;stop-opacity:1"          id="stop26" />       <stop          offset="0.87"          style="stop-color:#ff01d2;stop-opacity:1"          id="stop28" />       <stop          offset="0.95"          style="stop-color:#ff015b;stop-opacity:1"          id="stop30" />       <stop          offset="1"          style="stop-color:#ff0101;stop-opacity:1"          id="stop32" />     </linearGradient>     <linearGradient        xlink:href="#rainbow"        id="linearGradientRainbow"        gradientUnits="userSpaceOnUse"        x1="45"        y1="143"        x2="413"        y2="143"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3379"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3381"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3383"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3385"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3387"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3389"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3391"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3393"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3395"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3397"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3399"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3401"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />   </defs>   <metadata      id="metadata35">     <rdf:RDF>       <cc:Work          rdf:about="">         <dc:format>image/svg+xml</dc:format>         <dc:type            rdf:resource="http://purl.org/dc/dcmitype/StillImage" />         <dc:title></dc:title>         <dc:publisher>           <cc:Agent>             <dc:title></dc:title>           </cc:Agent>         </dc:publisher>         <dc:rights>           <cc:Agent>             <dc:title>AGPL</dc:title>           </cc:Agent>         </dc:rights>         <dc:creator>           <cc:Agent>             <dc:title>positivestuido.co</dc:title>           </cc:Agent>         </dc:creator>         <dc:date>2017</dc:date>         <dc:subject>           <rdf:Bag>             <rdf:li>sketch drawing board real-time canvas surface</rdf:li>           </rdf:Bag>         </dc:subject>       </cc:Work>     </rdf:RDF>   </metadata>   <g      inkscape:label="Layer 1"      inkscape:groupmode="layer"      id="layer1"      transform="translate(-359.92474,-9.2357351)">     <path        inkscape:connector-curvature="0"        id="path4215"        style="fill:url(#linearGradientRainbow);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 348.50715,25.511773 0,5.415323 -1.78128,0 0,-3.417866 -16.30852,0 0,7.412776 18.0898,0 0,11.407687 -24.70029,0 0,-5.415322 1.78127,0 0,3.417866 16.30852,0 0,-7.412776 -18.08979,0 0,-11.407688 24.70029,0 z" />     <path        inkscape:connector-curvature="0"        id="path4217"        style="fill:url(#linearGradient3401);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 380.66401,44.332237 0,1.997456 -9.65843,0 0,-1.997456 3.04795,0 -4.71047,-7.412776 -7.32301,0 0,7.412776 3.95839,0 0,1.997456 -14.48766,0 0,-1.997456 3.91879,0 0,-26.854671 -3.91879,0 0,-1.997453 10.52927,0 0,19.441893 7.28343,0 4.39379,-7.412776 -3.20628,0 0,-1.997457 9.65844,0 0,1.997457 -4.31462,0 -4.94798,8.344922 5.3834,8.478085 4.39378,0 z" />     <path        inkscape:connector-curvature="0"        id="path4219"        style="fill:url(#linearGradient3399);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 384.07627,25.511773 24.70027,0 0,11.407688 -18.08978,0 0,7.412776 16.30851,0 0,-3.417866 1.78127,0 0,5.415322 -24.70027,0 0,-20.81792 z m 6.61049,1.997457 0,7.412776 16.30851,0 0,-7.412776 -16.30851,0 z" />     <path        inkscape:connector-curvature="0"        id="path4221"        style="fill:url(#linearGradient3397);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 429.88582,44.332237 0,1.997456 -14.25015,0 0,-18.820463 -3.91879,0 0,-1.997457 3.91879,0 0,-10.03166 6.61049,0 0,10.03166 7.63966,0 0,1.997457 -7.63966,0 0,16.823007 7.63966,0 z" />     <path        inkscape:connector-curvature="0"        id="path4223"        style="fill:url(#linearGradient3395);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 456.01112,40.914371 1.78128,0 0,5.415322 -24.70029,0 0,-20.81792 24.70029,0 0,5.415323 -1.78128,0 0,-3.417866 -16.30851,0 0,16.823007 16.30851,0 0,-3.417866 z" />     <path        inkscape:connector-curvature="0"        id="path4225"        style="fill:url(#linearGradient3393);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 493.35532,44.332237 0,1.997456 -10.25221,0 0,-1.997456 4.23547,0 0,-16.823007 -16.3085,0 0,16.823007 3.91879,0 0,1.997456 -14.44809,0 0,-1.997456 3.91879,0 0,-26.854671 -3.91879,0 0,-1.997453 10.5293,0 0,10.03166 18.08978,0 0,18.820464 4.23546,0 z" />     <path        inkscape:connector-curvature="0"        id="path4227"        style="fill:url(#linearGradient3391);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 494.28615,54.3639 3.9188,0 0,-26.85467 -3.9188,0 0,-1.997457 29.17326,0 0,20.81792 -18.64395,0 0,8.034207 3.91879,0 0,1.997454 -14.4481,0 0,-1.997454 z m 27.39199,-26.85467 -16.86268,0 0,16.823007 16.86268,0 0,-16.823007 z" />     <path        inkscape:connector-curvature="0"        id="path4229"        style="fill:url(#linearGradient3389);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 552.68831,44.332237 3.91882,0 0,1.997456 -28.61909,0 0,-11.407687 18.08978,0 0,-7.412776 -16.30851,0 0,3.417866 -1.78127,0 0,-5.415323 24.70027,0 0,18.820464 z m -6.61049,0 0,-7.412776 -16.30851,0 0,7.412776 16.30851,0 z" />     <path        inkscape:connector-curvature="0"        id="path4231"        style="fill:url(#linearGradient3387);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 577.98669,25.511773 0,-8.034207 -3.91879,0 0,-1.997453 10.52928,0 0,28.852124 3.91879,0 0,1.997456 -29.17325,0 0,-20.81792 18.64397,0 z m -16.86269,18.820464 16.86269,0 0,-16.823007 -16.86269,0 0,16.823007 z" />     <path        inkscape:connector-curvature="0"        id="path4233"        style="fill:url(#linearGradient3385);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 599.21968,46.329693 -7.60009,0 0,-6.791347 7.60009,0 0,6.791347 z" />     <path        inkscape:connector-curvature="0"        id="path4235"        style="fill:url(#linearGradient3383);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 601.71129,54.3639 3.91879,0 0,-26.85467 -3.91879,0 0,-1.997457 29.17325,0 0,20.81792 -18.64396,0 0,8.034207 3.91878,0 0,1.997454 -14.44807,0 0,-1.997454 z m 27.39197,-26.85467 -16.86268,0 0,16.823007 16.86268,0 0,-16.823007 z" />     <path        inkscape:connector-curvature="0"        id="path4237"        style="fill:url(#linearGradient3381);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 659.83544,25.511773 0,5.370936 -1.78128,0 0,-3.373479 -12.86473,0 0,16.823007 3.91879,0 0,1.997456 -14.44807,0 0,-1.997456 3.91879,0 0,-16.823007 -3.91879,0 0,-1.997457 25.17529,0 z" />     <path        inkscape:connector-curvature="0"        id="path4239"        style="fill:url(#linearGradient3379);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 687.87312,46.329693 -24.70028,0 0,-20.81792 24.70028,0 0,20.81792 z m -1.78128,-18.820463 -16.3085,0 0,16.823007 16.3085,0 0,-16.823007 z" />   </g> </svg> '};function randomColor(){"use strict";return{r:Math.floor(255*Math.random()),g:Math.floor(0*Math.random()),b:Math.floor(0*Math.random()),a:1}}window.NSSketchpad=NSSketchpad,window.randomColor=randomColor;var supportsPassive=!1;try{var opts=Object.defineProperty({},"passive",{get:function(){"use strict";supportsPassive=!0}});window.addEventListener("test",null,opts)}catch(t){console.log("ignore",t)}function elementOffset(t){"use strict";var e=t.getBoundingClientRect();return{x:0-e.left,y:0-e.top}}function addEvent(o,t,r,e){"use strict";function s(){var t="";return window.getSelection?t=window.getSelection().toString():void 0!==document.selection&&"Text"===document.selection.type&&(t=document.selection.createRange().text),t}function i(t){var e,s,i=elementOffset(o);for(e=0;e<t.changedTouches.length;e+=1)(s=t.changedTouches[e]).offsetX=s.clientX+i.x,s.offsetY=s.clientY+i.y,r(s)}var a,n;switch(t){case"swipe-right":console.log("adding swipe right"),o.addEventListener("touchstart",function(t){a=t.changedTouches[0]},e),o.addEventListener("mousedown",function(t){console.log("mdsr"),a=t},e),o.addEventListener("touchend",function(t){(n=t.changedTouches[t.changedTouches.length-1])&&a&&30<n.screenX-a.screenX&&!s()&&"text"!==document.activeElement.type&&r(t)},e),o.addEventListener("mouseup",function(t){(n=t)&&a&&30<n.screenX-a.screenX&&!s()&&"text"!==document.activeElement.type&&r(t)},e);break;case"hover-in":o.addEventListener("touchstart",function(t){var e;for(e=0;e<t.changedTouches.length;e+=1)r(t.changedTouches[e])},e),o.addEventListener("touchmove",function(t){var e;for(e=0;e<t.changedTouches.length;e+=1)r(t.changedTouches[e])},e),o.addEventListener("mouseover",r,e);break;case"hover-out":o.addEventListener("mouseout",r,e);break;case"tap":o.addEventListener("touchstart",function(t){var e;for(t.preventDefault(),document.activeElement!==t.target&&"INPUT"===document.activeElement.tagName&&document.activeElement.blur(),e=0;e<t.changedTouches.length;e+=1)t.changedTouches[e].stopPropagation=t.stopPropagation&&t.stopPropagation.bind(t),t.changedTouches[e].preventDefault=t.preventDefault&&t.preventDefault.bind(t),r(t.changedTouches[e]);t.preventMouseFallback=!0},e),o.addEventListener("mousedown",function(t){r(t)},e);break;case"pop":o.addEventListener("touchend",function(t){var e;for(t.preventDefault(),document.activeElement!==t.target&&"INPUT"===document.activeElement.tagName&&document.activeElement.blur(),e=0;e<t.changedTouches.length;e+=1)t.changedTouches[e].stopPropagation=t.stopPropagation&&t.stopPropagation.bind(t),t.changedTouches[e].preventDefault=t.preventDefault&&t.preventDefault.bind(t),r(t.changedTouches[e]);t.preventMouseFallback=!0},e),o.addEventListener("mouseup",function(t){r(t)},e);break;case"slide":o.addEventListener("mousedown",r,e),o.addEventListener("mouseup",r,e),o.addEventListener("mousemove",function(t){(t.buttons||void 0===t.buttons&&t.which)&&r(t)},e),o.addEventListener("touchstart",i,e),o.addEventListener("touchend",i,e),o.addEventListener("touchmove",i,e);break;default:o.addEventListener(t,r,e)}}function Eventsmanager(){"use strict";this.registeredCallbacks={},this.registeredCallbacksOnce={}}function Resources(t){"use strict";return this.images=[],this.config=t,this.sketchpad=t.sketchpad,this}function Imagehost(t){"use strict";if(Eventsmanager.call(this,t),this.File=void 0,this.config=t,this.postPdfUrl=NSSketchpad&&NSSketchpad.postPdfUrl||"https://uploader.imagehost.pro:3443/upload",this.postImageUrl=NSSketchpad&&NSSketchpad.postImageUrl||"https://uploader.imagehost.pro:3443/upload",this.postWebshotUrl=NSSketchpad&&NSSketchpad.postWebshotUrl||"https://uploader.imagehost.pro:3443/webshot?site=",this.proxyImageUrl=NSSketchpad&&NSSketchpad.proxyImageUrl||"https://imagehost.pro/proxy",this.proxyExcludedDomain=NSSketchpad&&NSSketchpad.proxyExcludedDomain||"imagehost.pro",t.file&&this.uploadFile(t.file),t.url)if(this.isDataURL(t.url)){if(t.file=this.dataURItoFile(t.url),!t.file)return console.error("Error - wrong data url",t.url),this;this.uploadFile(t.file)}else this.proxyUrl(t.url);return this.progressbar=new Progressbar({name:t.url,progressParentEl:t.progressParentEl||window.document.body,style:{position:"absolute",top:0,left:0,zIndex:200,height:"2px",width:"2px",backgroundColor:"rgba(155, 0, 0, 0.5)"}}),this}function Progressbar(t){"use strict";return Eventsmanager.call(this,t),this.config=Object.assign({},t),this.prepareLoadingElements(),this}function Keyshortcuts(t){"use strict";Eventsmanager.call(this,t),this.shortcuts=[],this.registerEvents()}function Colorpalette(t){"use strict";Eventsmanager.call(this,t),"object"!=typeof t.keyModifiers&&(t.keyModifiers={});var e=t.containerEl;(this.containerEl=e).classList.add("colorpalette");var s=200,i=220;this.width=s,this.height=i,this.color={hue:0,saturation:0,value:0,red:0,green:0,blue:0,alpha:1},e.style.position="relative",e.style.width="200px",e.style.height="220px",e.style.display="inline-block",this.colorBgEl=document.createElement("div"),this.colorBgEl.style.backgroundImage="url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAB3RJTUUH4AcGEAAdMvv9RwAAAFBJREFUWMPt18EJACAIhWGLNnJah3Im28B36CDE/66CfBCirYgoa5KZ9hJ3b+vbhgMAAICj5lzNsYrqzxMAAAAAAAAA8/eA2vf8CwAA+B5wAUhhDw4II7MzAAAAAElFTkSuQmCC')",this.colorBgEl.style.backgroundSize="16px",this.colorBgEl.style.backgroundPosition="50% 50%",this.colorBgEl.className="color-bg",this.colorBgEl.style.width="200px",this.colorBgEl.style.height=Math.floor(20)+"px",this.colorBgEl.style.borderRadius=window.radius+"px "+window.radius+"px 0px 0px",this.colorBgEl.style.overflow="hidden",this.colorEl=document.createElement("div"),this.colorEl.className="color",this.colorEl.style.width="100%",this.colorEl.style.height="100%",this.colorEl.style.cursor="pointer",this.colorBgEl.appendChild(this.colorEl),this.colorBgEl.style.position="absolute",this.colorBgEl.style.top="0px",this.colorBgEl.style.left="0px",this.paletteCanvas=document.createElement("canvas"),this.paletteCanvas.className="palette",this.paletteCanvas.width=180,this.paletteCanvas.height=Math.floor(180),this.paletteContext2d=this.paletteCanvas.getContext("2d"),this.paletteIData=this.paletteContext2d.createImageData(this.paletteCanvas.width,this.paletteCanvas.height),this.paletteCanvas.style.cursor="crosshair",this.paletteCanvas.style.position="absolute",this.paletteCanvas.style.left="0px",this.paletteCanvas.style.top=Math.floor(20)+"px",this.palettePointerEl=document.createElement("div"),this.palettePointerEl.className="pointer palette-pointer",this.palettePointerEl.position="absolute",this.palettePointerEl.style.width="12px",this.palettePointerEl.style.height="12px",this.palettePointerEl.style.backgroundColor="white",this.palettePointerEl.style.position="absolute",this.palettePointerEl.style.borderRadius="50%",this.palettePointerEl.style.cursor="crosshair",this.palettePointerEl.style.boxShadow="inset 0 0 2px #000",this.hueCanvas=document.createElement("canvas"),this.hueCanvas.className="hue",this.hueCanvas.width=20,this.hueCanvas.height=180,this.hueContext2d=this.hueCanvas.getContext("2d"),this.hueIData=this.hueContext2d.createImageData(this.hueCanvas.width,this.hueCanvas.height),this.hueCanvas.style.cursor="row-resize",this.hueCanvas.style.position="absolute",this.hueCanvas.style.top="20px",this.hueCanvas.style.left="180px",this.hueSliderEl=document.createElement("div"),this.hueSliderEl.className="slider hue-slider",this.hueSliderEl.style.width="24px",this.hueSliderEl.style.height="6.6px",this.hueSliderEl.style.position="absolute",this.hueSliderEl.style.top="22px",this.hueSliderEl.style.left="178px",this.hueSliderEl.style.backgroundColor="white",this.hueSliderEl.style.cursor="row-resize",this.hueSliderEl.style.boxShadow="inset 0 0 2px #000",this.hueSliderEl.style.zIndex=100,this.alphaCanvas=document.createElement("canvas"),this.alphaCanvas.className="alpha",this.alphaCanvas.width=s,this.alphaCanvas.height=20,this.alphaContext2d=this.alphaCanvas.getContext("2d"),this.alphaIData=this.alphaContext2d.createImageData(this.alphaCanvas.width,this.alphaCanvas.height),this.alphaCanvas.style.backgroundImage="url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAB3RJTUUH4AcGEAAdMvv9RwAAAFBJREFUWMPt18EJACAIhWGLNnJah3Im28B36CDE/66CfBCirYgoa5KZ9hJ3b+vbhgMAAICj5lzNsYrqzxMAAAAAAAAA8/eA2vf8CwAA+B5wAUhhDw4II7MzAAAAAElFTkSuQmCC')",this.alphaCanvas.style.backgroundSize="16px",this.alphaCanvas.style.backgroundPosition="50% 50%",this.alphaCanvas.style.cursor="col-resize",this.alphaCanvas.style.position="absolute",this.alphaCanvas.style.top="200px",this.alphaCanvas.style.left="0px",this.alphaCanvas.style.borderRadius="0px 0px "+window.radius+"px "+window.radius+"px",this.alphaCanvas.style.overflow="hidden",this.alphaSliderEl=document.createElement("div"),this.alphaSliderEl.className="slider alpha-slider",this.alphaSliderEl.style.width="6px",this.alphaSliderEl.style.height="24.2px",this.alphaSliderEl.style.backgroundColor="white",this.alphaSliderEl.style.position="absolute",this.alphaSliderEl.style.top="197.8px",this.alphaSliderEl.style.left=this.alphaCanvas.width-3+"px",this.alphaSliderEl.style.cursor="col-resize",this.alphaSliderEl.style.boxShadow="inset 0 0 2px #000",this.alphaSliderEl.style.zIndex=100,this.redInput=document.createElement("input"),this.redInput.title="R:",this.greenInput=document.createElement("input"),this.greenInput.title="G:",this.blueInput=document.createElement("input"),this.blueInput.title="B:",this.alphaInput=document.createElement("input"),this.alphaInput.title="A:",this.valuesEl=document.createElement("div");var r=this;function o(t){r.changeAlpha(r.color.alpha-t.deltaX/100/2),t.preventDefault()}function a(t){r.changeHue(r.color.hue-t.deltaY/2),t.preventDefault()}function n(t){r.pickPalette(r.color.saturation-t.deltaX/2,r.color.value-t.deltaY/2),t.preventDefault()}return[this.redInput,this.greenInput,this.blueInput,this.alphaInput].forEach(function(t){var e=document.createElement("span");e.textContent=t.title,r.valuesEl.appendChild(e),r.valuesEl.appendChild(t),t.type="number",t.className=t.title,t===r.alphaInput?(t.min=0,t.max=1,t.step=.01,t.maxLength=4):(t.min=0,t.max=255,t.step=1,t.maxLength=3),t.addEventListener("change",function(){r.updateFromInputs()})}),e.appendChild(this.colorBgEl),e.appendChild(this.paletteCanvas),e.appendChild(this.hueCanvas),e.appendChild(this.alphaCanvas),e.appendChild(this.hueSliderEl),e.appendChild(this.alphaSliderEl),e.appendChild(this.palettePointerEl),this.drawHue(),this.drawPalette(this.color.hue),addEvent(this.hueCanvas,"slide",function(t){var e=r.normalize(t.offsetY,0,r.hueCanvas.height)/r.hueCanvas.height*360;r.changeHue(e)}),addEvent(this.colorEl,"tap",function(){var t=r.getColor();r.dispatch("set",{color:t})}),addEvent(this.paletteCanvas,"slide",function(t){var e=r.normalize(t.offsetX,0,r.paletteCanvas.width),s=r.normalize(t.offsetY,0,r.paletteCanvas.height),i=e/r.paletteCanvas.width*100,o=s/r.paletteCanvas.height*100;r.pickPalette(i,o)}),addEvent(this.alphaCanvas,"slide",function(t){var e=r.normalize(t.offsetX,0,r.alphaCanvas.width)/r.alphaCanvas.width*1;r.changeAlpha(e)}),this.setHueSlider(0),t.color&&this.setColor(t.color),this.alphaCanvas.addEventListener("wheel",o),this.alphaSliderEl.addEventListener("wheel",o),this.hueCanvas.addEventListener("wheel",a),this.hueSliderEl.addEventListener("wheel",a),this.paletteCanvas.addEventListener("wheel",n),this.palettePointerEl.addEventListener("wheel",n),this.keyshortcuts=new Keyshortcuts,this.keyshortcuts.disable(),this.keyshortcuts.addShortcut(Object.assign({altKey:!1,keyCode:38,repeatable:!0},t.keyModifiers),function(){r.changeHue(r.color.hue-1)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!1,keyCode:40,repeatable:!0},t.keyModifiers),function(){r.changeHue(r.color.hue+1)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!1,keyCode:37,repeatable:!0},t.keyModifiers),function(){r.changeAlpha(r.color.alpha-.01)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!1,keyCode:39,repeatable:!0},t.keyModifiers),function(){r.changeAlpha(r.color.alpha+.01)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:38,repeatable:!0},t.keyModifiers),function(){r.pickPalette(r.color.saturation,r.color.value-1)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:40,repeatable:!0},t.keyModifiers),function(){r.pickPalette(r.color.saturation,r.color.value+1)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:37,repeatable:!0},t.keyModifiers),function(){r.pickPalette(r.color.saturation-1,r.color.value)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:39,repeatable:!0},t.keyModifiers),function(){r.pickPalette(r.color.saturation+1,r.color.value)}),this}function Pixelpicker(t){"use strict";Eventsmanager.call(this,t),"object"!=typeof t.keyModifiers&&(t.keyModifiers={});var e=t.containerEl;(this.containerEl=e).classList.add("Pixelpicker");var s=200,i=220;this.width=s,this.height=i,this.threshold=.15,this.x=0,this.y=0,this.color={hue:0,saturation:0,value:0,red:0,green:0,blue:0,alpha:1},e.style.position="relative",e.style.width="200px",e.style.height="220px",e.style.display="inline-block",this.colorBgEl=document.createElement("div"),this.colorBgEl.style.backgroundImage="url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAB3RJTUUH4AcGEAAdMvv9RwAAAFBJREFUWMPt18EJACAIhWGLNnJah3Im28B36CDE/66CfBCirYgoa5KZ9hJ3b+vbhgMAAICj5lzNsYrqzxMAAAAAAAAA8/eA2vf8CwAA+B5wAUhhDw4II7MzAAAAAElFTkSuQmCC')",this.colorBgEl.style.backgroundSize="16px",this.colorBgEl.style.backgroundPosition="50% 50%",this.colorBgEl.className="color-bg",this.colorBgEl.style.width="200px",this.colorBgEl.style.height=Math.floor(20)+"px",this.colorBgEl.style.borderRadius=window.radius+"px "+window.radius+"px 0px 0px",this.colorBgEl.style.overflow="hidden",this.colorEl=document.createElement("div"),this.colorEl.className="color",this.colorEl.style.width="100%",this.colorEl.style.height="100%",this.colorEl.style.cursor="pointer",this.colorBgEl.appendChild(this.colorEl),this.colorBgEl.style.position="absolute",this.colorBgEl.style.top="0px",this.colorBgEl.style.left="0px",this.paletteBgEl=document.createElement("div"),this.paletteBgEl.className="palette-bg",this.paletteBgEl.style.position="absolute",this.paletteBgEl.style.backgroundImage="url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAB3RJTUUH4AcGEAAdMvv9RwAAAFBJREFUWMPt18EJACAIhWGLNnJah3Im28B36CDE/66CfBCirYgoa5KZ9hJ3b+vbhgMAAICj5lzNsYrqzxMAAAAAAAAA8/eA2vf8CwAA+B5wAUhhDw4II7MzAAAAAElFTkSuQmCC')",this.paletteBgEl.style.backgroundSize="16px",this.paletteBgEl.style.backgroundPosition="50% 50%",this.paletteBgEl.style.width="200px",this.paletteBgEl.style.height=Math.floor(200)+"px",this.paletteBgEl.style.borderRadius=window.radius+"px "+window.radius+"px 0px 0px",this.paletteBgEl.style.overflow="hidden",this.paletteBgEl.style.left="0px",this.paletteBgEl.style.top=Math.floor(20)+"px",this.paletteCanvas=document.createElement("canvas"),this.paletteCanvas.className="palette",this.paletteCanvas.width=s,this.paletteCanvas.height=Math.floor(200),this.paletteContext2d=this.paletteCanvas.getContext("2d"),this.paletteIData=this.paletteContext2d.createImageData(this.paletteCanvas.width,this.paletteCanvas.height),this.paletteCanvas.style.cursor="crosshair",this.paletteCanvas.style.position="absolute",this.paletteCanvas.style.left="0px",this.paletteCanvas.style.top=Math.floor(20)+"px";var o=this,r=document.createElement("img");function a(t){o.changeThreshold(o.threshold-t.deltaX/100/2),t.preventDefault()}function n(t){o.pickPalette(o.x-t.deltaX/2,o.y-t.deltaY/2),t.preventDefault()}return r.addEventListener("load",function(){o.paletteContext2d.drawImage(r,0,0,r.width,r.height,0,0,o.width,o.width*(r.height/r.width))}),r.src=t.imageSrc,this.palettePointerEl=document.createElement("div"),this.palettePointerEl.className="pointer palette-pointer",this.palettePointerEl.position="absolute",this.palettePointerEl.style.width="12px",this.palettePointerEl.style.height="12px",this.palettePointerEl.style.backgroundColor="transparent",this.palettePointerEl.style.position="absolute",this.palettePointerEl.style.border="1px solid white",this.palettePointerEl.style.borderRadius="50%",this.palettePointerEl.style.cursor="crosshair",this.palettePointerEl.style.boxShadow="inset 0 0 2px #000",this.thresholdSliderEl=document.createElement("div"),this.thresholdSliderEl.className="slider alpha-slider",this.thresholdSliderEl.style.width="6px",this.thresholdSliderEl.style.height="24.2px",this.thresholdSliderEl.style.backgroundColor="transparent",this.thresholdSliderEl.style.border="1px solid white",this.thresholdSliderEl.style.position="absolute",this.thresholdSliderEl.style.top="-2.2px",this.thresholdSliderEl.style.left=this.width-3+"px",this.thresholdSliderEl.style.cursor="col-resize",this.thresholdSliderEl.style.boxShadow="inset 0 0 2px #000",this.thresholdSliderEl.style.zIndex=100,this.redInput=document.createElement("input"),this.redInput.title="R:",this.greenInput=document.createElement("input"),this.greenInput.title="G:",this.blueInput=document.createElement("input"),this.blueInput.title="B:",this.alphaInput=document.createElement("input"),this.alphaInput.title="A:",this.valuesEl=document.createElement("div"),[this.redInput,this.greenInput,this.blueInput,this.alphaInput].forEach(function(t){var e=document.createElement("span");e.textContent=t.title,o.valuesEl.appendChild(e),o.valuesEl.appendChild(t),t.type="number",t.className=t.title,t===o.alphaInput?(t.min=0,t.max=1,t.step=.01,t.maxLength=4):(t.min=0,t.max=255,t.step=1,t.maxLength=3),t.addEventListener("change",function(){o.updateFromInputs()})}),e.appendChild(this.colorBgEl),e.appendChild(this.paletteBgEl),e.appendChild(this.paletteCanvas),e.appendChild(this.thresholdSliderEl),e.appendChild(this.palettePointerEl),addEvent(this.paletteCanvas,"slide",function(t){var e=o.normalize(t.offsetX,0,o.paletteCanvas.width),s=o.normalize(t.offsetY,0,o.paletteCanvas.height);o.pickPalette(e,s)}),addEvent(this.colorEl,"slide",function(t){var e=o.normalize(t.offsetX,0,o.width)/o.width*1;o.changeThreshold(e)}),this.colorEl.addEventListener("wheel",a),this.thresholdSliderEl.addEventListener("wheel",a),this.setThresholdSlider(0),t.color&&this.setColor(t.color),this.paletteCanvas.addEventListener("wheel",n),this.palettePointerEl.addEventListener("wheel",n),this.keyshortcuts=new Keyshortcuts,this.keyshortcuts.disable(),this.keyshortcuts.addShortcut(Object.assign({altKey:!1,keyCode:37,repeatable:!0},t.keyModifiers),function(){o.changeThreshold(o.threshold-.01)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!1,keyCode:39,repeatable:!0},t.keyModifiers),function(){o.changeThreshold(o.threshold+.01)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:38,repeatable:!0},t.keyModifiers),function(){o.pickPalette(o.color.saturation,o.color.value-1)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:40,repeatable:!0},t.keyModifiers),function(){o.pickPalette(o.color.saturation,o.color.value+1)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:37,repeatable:!0},t.keyModifiers),function(){o.pickPalette(o.color.saturation-1,o.color.value)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:39,repeatable:!0},t.keyModifiers),function(){o.pickPalette(o.color.saturation+1,o.color.value)}),this}function Sketch(t){"use strict";return Eventsmanager.call(this,t),this.config=Object.assign({sid:String(Date.now()+Math.random()),cts:Date.now()},t),this.toolsCache=[],this.framesHistory=[],this.newFrames=[],this.myStash=[],this.bulkId=0,this.grindingThreshold=1e3/60,this.userBFramesCounter=0,this.setConfig(this.config),this}function Room(t,e){"use strict";if(!(e instanceof Sketchpad))throw new Error("Room(room_token, sketchpad)",t,"sketchpad must be instanceof Sketchpad.");return this.sketchpad=e,this.room_token=t,this.sketches=[],this.prevSketch=[],this.totalCount=0,this.clients=[],e.room=this}function Input(t){"use strict";return Input.prototype.instance+=1,this.timestamp=(new Date).getTime(),this.type=t.type||"draw",this.uid=t.uid,this.id=t.id,this.layers=t.layers,this.tool=t.tool,this.font=t.font,this.color=t.color,this.fillColor=t.fillColor,this.size=t.size,this.center=t.center,this.listT=[],this.listX=[],this.listY=[],this.listP=[],this.lastT=NaN,this.lastX=NaN,this.lastY=NaN,this.lastP=NaN,this.lastSendPointer=0,this.lastDrawPointer=0,this.sketchpad=t.sketchpad,this.viewportX=this.sketchpad.viewportX,this.viewportY=this.sketchpad.viewportY,this.scale=this.sketchpad.scale,this.rotation=this.sketchpad.rotation,this.width=this.sketchpad.width,this.height=this.sketchpad.height,this.UID=this.sketchpad.UID,this.url=t.url,this}function Tool(t){"use strict";if(Eventsmanager.call(this,t),!t)return this;if(!(t.sketchpad instanceof Sketchpad))throw console.warn("config.sketchpad must be instanceof Sketchpad"),new Error("config.sketchpad must be instanceof Sketchpad");this.sketchpad=t.sketchpad,t.toolId&&(this.toolId=t.toolId),t.lineWidth&&(this.lineWidth=t.lineWidth),t.layers&&(this.layers=t.layers),t.color&&(this.color=t.color)}function ToolFillable(t){"use strict";Tool.call(this,t)}function ToolCirc(t){"use strict";ToolFillable.call(this,t)}function ToolColorpicker(t){"use strict";ToolFillable.call(this,t),this.toolId=t.toolId||"colorpicker",this.layers=[]}function ToolCustom(t){"use strict";Tool.call(this,t)}function ToolCutout(t){"use strict";Tool.call(this,t),this.toolId=t.toolId||"cutout"}function ToolEraser(t){"use strict";Tool.call(this,t)}function ToolHighlighter(t){"use strict";Tool.call(this,t)}function ToolImage(t){"use strict";Tool.call(this,t);var n=this;this.emptyImage=document.createElement("img"),this.emptyImage.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAArrAAAK6wGCiw1aAAAAB3RJTUUH4QQJFQY3bU7o3wAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAACR0lEQVR42uWbsU7rMBSG//ObMRkQguVKvAHv/wrsvEGlLiDUIdHd7MNAkHp7AzSJ7WM7lrK0Q+Uv+b6kR4oAeAbwAkCmYw9Lp+PpZtr8X+/9iaTuYfchBHHO3QJ4IQDx3p+cc/c7Oftwzt17708AhACEpKrqq4g8tr55EXlU1dfpahf+I4bqoWUI0+YP55/xvzp8QngYx9G1svFxHJ2IPFxufhYAAAzD8N73/V0rAPq+vxuG4X3uu1kAXdf5Vprw5XzXdf5qAK00Yc75RQBqbcJPzi8GUGMTfnJ+FYCamvCb86sA1NKEa5zfBKDUJixxfjOAEpuwxPkoAEpqwlLnowAopQlrnI8KwKoJW5yPDsCiCVucTwIgZxO2Op8EQK4mxHA+KYBUTYjpfHIAKZoQ0/ksAGI2IbbzWQDEakIK57MCWNuElM5nB7CmCSmdNwGwpAmpnTcBcG0TcjhvCuC7JuR03hzAXBNyOn+5bix+9KwJf6ar4mj1l5rY+TIBcOb8UVWPljNGEwCXzlvOGLMDmLvPW84YabD5g9U8wQzAkvt87hkjLZzPPU8wBbDm2T5nE2jpfOp5ghmAmM/2qZvAEpy3bAJLcN6yCSzJeYsmsDTnczeBJTqfswks0fmcTWDJzudoAkt3PnUTWIPzKZvAGpxP2QTW5HyKJrA252M3gTU6H7MJrNH5mE1gzc7HaAJrd35rE9iC81uawBac39IEtuT8miYQgIYQpBXnr21CCEEAKAGoc+7We/+GnSzv/dv08rQKdv76/Af/G22JqgLBTAAAAABJRU5ErkJggg==";var l=this.sketchpad;document.addEventListener("paste",function(t){if(!n.disabled){var i=t.clipboardData&&t.clipboardData.items||t.originalEvent.clipboardData&&t.originalEvent.clipboardData.items;Object.keys(i).forEach(function(t){var e=i[t];if("file"===e.kind){var s=e.getAsFile();window.tmp=new Imagehost({progressParentEl:l.progressParentEl||l.containerEl,file:s}).on("success",function(t){n.onImagehostReady(t.url,0,0,0,0,!0)}).on("error",n.onImagehostError.bind(n))}})}}),this.sketchpad.containerEl.addEventListener("dragover",function(t){n.disabled||t.preventDefault()}),this.sketchpad.containerEl.addEventListener("dragenter",function(t){n.disabled}),this.sketchpad.containerEl.addEventListener("drop",function(t){if(!n.disabled){var e=n.sketchpad.mainPos(t.clientX,t.clientY),s=t.dataTransfer.getData("URL");if(s)return window.tmp=new Imagehost({progressParentEl:l.progressParentEl||l.containerEl,url:s}).on("success",function(t){n.onImagehostReady(t.url,e.x,e.y,e.x,e.y)}).on("error",n.onImagehostError.bind(n)),void t.preventDefault();var i=t.dataTransfer.getData("text/html").match(/<img.+src\=(?:\"|\')(.+?)(?:\"|\')(?:.+?)>/);if(i&&i[1]){var o=document.createElement("span");return o.innerHTML=i[1],console.log("URL PARSED",encodeURI(o.textContent)),window.tmp=new Imagehost({progressParentEl:l.progressParentEl||l.containerEl,url:encodeURI(o.textContent)}).on("success",function(t){n.onImagehostReady(t.url,e.x,e.y,e.x,e.y)}).on("error",n.onImagehostError.bind(n)),void t.preventDefault()}var r=t.dataTransfer.files;if(0<r.length){var a=r[0];return void 0===FileReader||-1===a.type.indexOf("image")&&-1===a.type.indexOf("pdf")||(window.tmp=new Imagehost({progressParentEl:l.progressParentEl||l.containerEl,file:a}).on("success",function(t){n.onImagehostReady(t.url,e.x,e.y,e.x,e.y)}).on("error",n.onImagehostError.bind(n))),void t.preventDefault()}}})}function ToolLine(t){"use strict";Tool.call(this,t),this.toolId=t.toolId||"line"}function ToolMandala(t){"use strict";Tool.call(this,t)}function ToolMoveViewport(t){"use strict";Tool.call(this,t),this.toolId=t.toolId||"move-viewport",this.layers=[]}function ToolNull(t){"use strict";Tool.call(this,t),this.toolId=t.toolId||"null",this.layers=[]}function ToolPen(t){"use strict";Tool.call(this,t)}function ToolRainbow(t){"use strict";Tool.call(this,t)}function ToolRect(t){"use strict";ToolFillable.call(this,t)}function ToolRotateViewport(t){"use strict";Tool.call(this,t),this.toolId=t.toolId||"rotate-viewport",this.layers=[]}function ToolType(t){"use strict";Tool.call(this,t),this.toolId=t.toolId||"type"}function calculateOffsetXY(t,e,s){"use strict";var i=t.currentStyle||window.getComputedStyle(t,null),o=parseInt(i.borderLeftWidth,10)||0,r=parseInt(i.borderTopWidth,10)||0,a=t.getBoundingClientRect();return{x:e-o-a.left,y:s-r-a.top}}function randomName(t){"use strict";var e,s=["a","e","i","o","u","y"],i=["b","c","d","g","h","j","k","l","m","n","p","r","s","t","v","w"],o="";for(e=0;e<t;e+=1)o+=i[Math.floor(Math.random()*i.length)]+s[Math.floor(Math.random()*s.length)];return o.substring(0,t)}function Sketchpad(e){"use strict";Eventsmanager.call(this,e),console.log("sketchpad.js","Sketchpad::constructor",e);var t=randomName(6),s=randomColor();e.features||(e.features="*"),this.initialised=!1,this.drawingPaused=!1,this.pausedQueue=[],this.displayCrosshair=!0,this.displayGrid=!1,this.UID=t[0].toUpperCase()+t.substr(1),this.user={},this.COLOR=s,this.editorsCount=0,this.viewersCount=0,this.resources=new Resources({sketchpad:this}),e=e||{},NSSketchpad.watermarkImageSrc&&(this.watermark=new Image,this.watermark.src=NSSketchpad.watermarkImageSrc,this.watermark.title=NSSketchpad.watermarkTitle,this.watermark.alt="sketchpad.pro",this.watermark.style.cursor="help", this.watermark.style.display="none",this.watermark.onload=function(){var t=this;t.addEventListener("click",function(){alert(t.title)})},this.watermark.style.position="absolute",this.watermark.style.right="0px",this.watermark.style.bottom="0px",this.watermark.crossOrigin="anonymous"),this.password=e.password||"",this.setMetaConfigFreeze=NaN,this.config=e,this.token=e.token||"#public",this.ws=e.ws||{addEventListener:function(){},send:function(){}},this.containerEl=e.containerEl||document.body,this.progressParentEl=e.progressParentEl||this.containerEl,this.syncNetworkDataFrequency=e.syncNetworkDataFrequency||Math.round(1e3),this.syncPointerDataFrequency=e.syncPointerDataFrequency||Math.round(100),this.centerViewport=!0,this.readOnly=e.readOnly||!1,this.tools={},this.tool=null,this.viewportX=parseFloat(e.viewportX)||0,this.viewportY=parseFloat(e.viewportY)||0,this.scale=parseFloat(e.viewportScale)||1,this.rotation=parseFloat(e.viewportZRotation)||0,this.LAYER_FRONT="F",this.LAYER_BACK="B",this.receivingHistory=!1,this.inputs={},this.backgroundCanvas=document.createElement("canvas"),this.backgroundCanvas.style.width="100%",this.backgroundCanvas.style.height="100%",this.backgroundCanvas.style.position="absolute",this.backgroundCanvas.style.transformOrigin="0 0",this.backgroundCanvas.style.webkitTransformOrigin="0 0",this.backgroundCanvas.style.MozTransformOrigin="0 0",this.backgroundCanvas.style.msTransformOrigin="0 0",this.backgroundCanvas.style.OTransformOrigin="0 0",this.containerEl.appendChild(this.backgroundCanvas),this.backgroundIFrame=document.createElement("iframe"),this.backgroundIFrame.style.display="none",this.backgroundIFrame.style.position="absolute",this.backgroundIFrame.style.transformOrigin="0 0",this.backgroundIFrame.style.webkitTransformOrigin="0 0",this.backgroundIFrame.style.MozTransformOrigin="0 0",this.backgroundIFrame.style.msTransformOrigin="0 0",this.backgroundIFrame.style.OTransformOrigin="0 0",this.backgroundIFrame.style.border=0,this.containerEl.appendChild(this.backgroundIFrame),this.background=document.createElement("img"),this.background.style.position="absolute",this.background.style.transformOrigin="0 0",this.background.style.webkitTransformOrigin="0 0",this.background.style.MozTransformOrigin="0 0",this.background.style.msTransformOrigin="0 0",this.background.style.OTransformOrigin="0 0",this.containerEl.appendChild(this.background),this.hudsEl=document.createElement("div"),this.hudsEl.style.zIndex=1,this.hudsEl.style.width="100%",this.hudsEl.style.height="100%",this.hudsEl.style.position="absolute",this.hudsEl.style.backgroundPosition="center center",this.hudsEl.style.transformOrigin="0 0",this.hudsEl.style.webkitTransformOrigin="0 0",this.hudsEl.style.MozTransformOrigin="0 0",this.hudsEl.style.msTransformOrigin="0 0",this.hudsEl.style.OTransformOrigin="0 0",this.hudsEl.style.transition="opacity .5s",this.containerEl.appendChild(this.hudsEl),this.projectorEl=document.createElement("div"),this.projectorEl.style.zIndex=2,this.projectorEl.style.width="100%",this.projectorEl.style.height="100%",this.projectorEl.style.position="absolute",this.projectorEl.style.backgroundPosition="center center",this.projectorEl.style.transformOrigin="0 0",this.projectorEl.style.webkitTransformOrigin="0 0",this.projectorEl.style.MozTransformOrigin="0 0",this.projectorEl.style.msTransformOrigin="0 0",this.projectorEl.style.OTransformOrigin="0 0",this.pointerEl=document.createElement("div"),this.pointerEl.position="absolute",this.pointerEl.display="none",this.projectorEl.appendChild(this.pointerEl),this.containerEl.appendChild(this.projectorEl),this.canvas=document.createElement("canvas"),this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="absolute",this.canvasB=document.createElement("canvas"),this.canvasB.style.width="100%",this.canvasB.style.height="100%",this.canvasB.style.position="absolute",this.canvasProjector=document.createElement("canvas"),this.canvasProjector.style.width="100%",this.canvasProjector.style.height="100%",this.canvasProjector.style.position="absolute",this.objectsCanva=document.createElement("div"),this.objectsCanva.style.width="100%",this.objectsCanva.style.height="100%",this.objectsCanva.style.position="absolute",this.foreground=document.createElement("img"),this.foreground.style.position="absolute",this.foreground.style.transformOrigin="0 0",this.foreground.style.webkitTransformOrigin="0 0",this.foreground.style.MozTransformOrigin="0 0",this.foreground.style.msTransformOrigin="0 0",this.foreground.style.OTransformOrigin="0 0",this.crosshairEl=document.createElement("div"),this.crosshairEl.className="crosshair",this.crosshairEl.style.position="absolute",this.crosshairEl.style.transformOrigin="0 0",this.crosshairEl.style.webkitTransformOrigin="0 0",this.crosshairEl.style.MozTransformOrigin="0 0",this.crosshairEl.style.msTransformOrigin="0 0",this.crosshairEl.style.OTransformOrigin="0 0",this.crosshairEl.style.backgroundImage="url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QAQAA9AFN/YZW7AAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAB3RJTUUH4AoTDyESpvZyZAAAANxJREFUWMPtllEKwjAQRF+ipghKFVqhXs/jeAbvIOKpLMUfQVpt4k8LIkULsSxiBvZr2c0wO7sEAgICfh3Hw34t+f4S2Po00F8gsQKMJAElqoAxBuAuReAex3Ep7QErTcAL4z5jbuXuqJ055zSwAG5v+p59HLwDJgBpmgKUjezKOTdSSk2ttVetdQ24RtUoz/O2/gZsfI/Nc8yfIkuSZAdkjVL6JcynG9FnBOc3uVIpVQMXoOrIV4OvYSP7726Blu7hTcBaG/X00iAExkVRiI9A1IQVcPrrL1lAgDceLw8ximVPrtAAAAAASUVORK5CYII=')",this.loadingEl=document.createElement("div"),this.loadingEl.style.position="absolute",this.loadingEl.style.display="flex",this.loadingEl.style.width="100%",this.loadingEl.style.height="100%",this.loadingEl.style.backgroundColor="rgba(255, 255, 255, .4)",this.loadingEl.textContent="...please wait...",this.loadingEl.style.color="#000",this.loadingEl.style.justifyContent="center",this.loadingEl.style.alignItems="center",this.containerEl.style.position="relative",this.containerEl.style.overflow="hidden",this.containerEl.appendChild(this.canvasB),this.containerEl.appendChild(this.objectsCanva),this.containerEl.appendChild(this.canvas),this.containerEl.appendChild(this.canvasProjector),this.watermark&&this.containerEl.appendChild(this.watermark),this.containerEl.appendChild(this.foreground),this.containerEl.appendChild(this.crosshairEl),this.containerEl.appendChild(this.loadingEl),this.width=0,this.height=0,this.windowWidth=0,this.windowHeight=0,this.room=new Room(this.token,this),this.away=!1;var o=this;function i(){o.lastSendPointerX===o.pointerX&&o.lastSendPointerY===o.pointerY||(o.lastSendPointerX=o.pointerX,o.lastSendPointerY=o.pointerY,o.sendMessageToServer({cmd:"pointer-move",x:o.pointerX,y:o.pointerY})),setTimeout(i,o.syncPointerDataFrequency)}function r(t){o.openConnection(t,o.token);var e=Object.assign({},o.config);delete e.ws,delete e.containerEl;var s={cmd:"open",user_id:o.UID,user_color:o.COLOR,room_token:o.token,room_password:o.password,room_config:e,viewportX:parseFloat(o.viewportX)||0,viewportY:parseFloat(o.viewportY)||0,width:parseFloat(o.width)||0,height:parseFloat(o.height)||0,viewportScale:parseFloat(o.scale)||1,viewportZRotation:parseFloat(o.rotation)||0},i=JSON.stringify(s);o.ws.send(i),o.dispatch("initConnection")}return NSSketchpad.avaliableTools.forEach(function(t){o.registerTool(t.prototype.toolId,t,{})}),this.setTool(NSSketchpad.defaultTool),setTimeout(function(){if(o.clearSketchpad(),o.createEventsDraw(),o.syncNetworkData(),i(),o.syncCanvasFrame(),o.setMetaConfig(e,!1),o.ws.addEventListener("message",function(t){o.receiveMessageFromServer(t)},!0),1===o.ws.readyState?r():o.ws.addEventListener("open",r,!0),o.initialised=!0,o.config.createPageConfig){var t=o.room.addSketch(o,o.config.createPageConfig);o.room.setActiveSketch(o,t)}o.dispatch("initialised",this)},0),this}window.supportsPassive=supportsPassive,window.addEvent=addEvent,Eventsmanager.prototype={on:function(t,e){"use strict";return this.registeredCallbacks[t]||(this.registeredCallbacks[t]=[]),this.registeredCallbacks[t].push(e),this},removeListener:function(t,e){"use strict";if(this.registeredCallbacks[t]){var s;for(s=this.registeredCallbacks[t].length-1;0<=s;s-=1)this.registeredCallbacks[t][s]===e&&this.registeredCallbacks[t].splice(s,1);this.registeredCallbacks[t].indexOf(e)}},once:function(t,e,s){"use strict";this.registeredCallbacksOnce[t]||(this.registeredCallbacksOnce[t]=[]);var i=!1;return s&&this.registeredCallbacksOnce[t].forEach(function(t){if(t.id===s)return t.fn=e,void(i=!0)}),i||this.registeredCallbacksOnce[t].push({id:s,fn:e}),this},dispatch:function(t,e,s,i){"use strict";var o=this;return this.registeredCallbacks[t]&&this.registeredCallbacks[t].forEach(function(t){t.call(o,e,s,i)}),this.registeredCallbacksOnce[t]&&(this.registeredCallbacksOnce[t].forEach(function(t){t.fn.call(o,e,s,i)}),delete this.registeredCallbacksOnce[t]),this}},window.Eventsmanager=Eventsmanager,Object.assign(Resources.prototype,{getImage:function(t,e,s){"use strict";var i,o,r=this;function a(t){e(i),r.sketchpad.planRefreshWindow(0,"resources.js:getImage:onImageLoadedOnce")}for(o=0;o<this.images.length;o+=1)if((i=this.images[o]).url===t){if(i.loaded){if(i.success)e(i);else if("function"==typeof s)return s(i)}else i.img.addEventListener("load",a);return}var n=new Image;n.crossOrigin="anonymous";var l=new Progressbar({progressParentEl:this.sketchpad.progressParentEl});l.startFakeProgress(),i={url:t,loaded:!1,progressbar:l,img:n},n.src=t,n.addEventListener("load",function(t){i.loaded=!0,i.success=!0,console.log("on image loaded"),i.loadEvent=t,i.progressbar.uploadComplete(),a()}),n.addEventListener("error",function(t){if(i.loaded=!0,i.success=!1,i.loadEvent=t,i.progressbar.cancel(),"function"==typeof s)return s(i)}),this.images.push(i)}}),window.Resources=Resources,Imagehost.prototype=Object.create(Eventsmanager.prototype),Object.assign(Imagehost.prototype,{isDataURL:function(t){"use strict";return!!t.match(/^\s*data:([a-z]+\/[a-z]+(;[a-z\-]+\=[a-z\-]+)?)?(;base64)?,[a-z0-9\!\$\&\'\,\(\)\*\+\,\;\=\-\.\_\~\:\@\/\?\%\s]*\s*$/i)},dataURItoFile:function(t){"use strict";if("string"==typeof t){var e,s=(t=t.split(","))[0].split(":")[1].split(";")[0],i=atob(t[1]),o=i.length,r=new ArrayBuffer(o),a=new Uint8Array(r);for(e=0;e<o;e+=1)a[e]=i.charCodeAt(e);return new File([a],"file",{type:s})}this.dispatch("error",{type:"upload",message:"dataURI must be a string."})},proxyUrl:function(t){"use strict";var e=document.createElement("a");e.href=t;var s=this;function i(t){setTimeout(function(){s.dispatch("success",{status:"ok",url:t})},0)}-1!==String(e.hostname).indexOf(this.proxyExcludedDomain)?i(t):i(this.proxyImageUrl+"?url="+encodeURIComponent(t))},uploadProgress:function(t){"use strict";this.dispatch("progress",t.loaded/t.total)},uploadFile:function(t){"use strict";this.File=t,(new FormData).append("fileToUpload",t);var e,s=new XMLHttpRequest,i=this;switch(s.upload.addEventListener("progress",function(t){i.uploadProgress(t),i.progressbar.uploadProgress(t)},!1),s.addEventListener("load",function(t){console.log("uploading load",t),i.uploadComplete(t),i.progressbar.uploadComplete(t)},!1),s.addEventListener("error",function(t){console.log("uploading error",t),i.uploadFailed(t),i.progressbar.uploadFailed(t)},!1),s.addEventListener("abort",function(t){i.uploadCanceled(t),i.progressbar.uploadCanceled(t)},!1),String(t.type)){case"application/pdf":e=this.postPdfUrl;break;default:e=this.postImageUrl}s.open("POST",e),s.setRequestHeader("Content-Type",t.type),s.setRequestHeader("Content-Name",encodeURI(t.name)),s.setRequestHeader("Content-Size",t.size),s.setRequestHeader("Content-LastModified",t.lastModified),s.send(t),this.dispatch("upload",s)},uploadComplete:function(t){"use strict";var e={};try{e=JSON.parse(t.target.response)}catch(t){this.dispatch("error",{type:"parse",title:"Upload fail",message:"Uknown response from server.",err:t})}e&&"ok"===e.status?this.dispatch("success",e):this.dispatch("error",{type:"response",title:"Upload fail",message:e&&e.message||"Your upload was rejected by server.",response:e})},uploadFailed:function(t){"use strict";console.error("uploadFailed",t),this.dispatch("error",{type:"fail",title:"Upload fail",message:"There was an error attempting to upload the file.",e:t})},uploadCanceled:function(t){"use strict";this.dispatch("error",{type:"cancelled",title:"Upload cancelled",message:"The upload has been canceled by the user or the browser dropped the connection.",e:t})}}),window.Imagehost=Imagehost,Progressbar.prototype=Object.create(Eventsmanager.prototype),Object.assign(Progressbar.prototype,{prepareLoadingElements:function(){"use strict";this.id=parseInt(1e3*Math.random(),10),this.loadingBarEl=document.createElement("div");var t=Object.assign({position:"absolute",top:0,left:0,zIndex:200,height:"2px",width:"2px",backgroundColor:"rgba(0, 0, 155, 0.5)",transition:"width 0.4s ease-in-out",webkitTransition:"width 0.4s ease-in-out",MozTransition:"width 0.5s ease-in-out",msTransition:"width 0.5s ease-in-out",OTransition:"width 0.5s ease-in-out"},this.config.style);Object.assign(this.loadingBarEl.style,t),this.config.progressParentEl||(this.config.progressParentEl=window.document.body),this.config.progressParentEl.appendChild(this.loadingBarEl)},uploadProgress:function(t){"use strict";this.dispatch("progress",t.loaded/t.total),this.loadingBarEl.style.width=parseInt(t.loaded/t.total*100,10)+"%"},uploadCompleteDestructor:function(){"use strict";this.config.progressParentEl.removeChild(this.loadingBarEl)},uploadComplete:function(){"use strict";this.completed?console.log("%cDOUBLED COMPLETE","background-color:orange",this.id):(this.completed=!0,this.uploadProgress({loaded:1,total:1}),clearInterval(this.fakeProgressTo),setTimeout(this.uploadCompleteDestructor.bind(this),500))},startFakeProgress:function(){"use strict";var t=this;t.fakeProgress=0,t.fakeTotal=100,this.fakeProgressTo=setInterval(function(){t.fakeProgress+=.01*(t.fakeTotal-t.fakeProgress),t.uploadProgress({loaded:t.fakeProgress,total:t.fakeTotal})},100)},cancel:function(t){"use strict";this.completed?console.log("%DOUBLED CANCEL","background-color:orange",this.id):(console.log("%cCANCEL","background-color:orange",this.id,t),clearInterval(this.fakeProgressTo),this.config.progressParentEl.removeChild(this.loadingBarEl),this.completed=!0)},uploadCanceled:function(t){"use strict";this.cancel(t)},uploadFailed:function(t){"use strict";this.cancel(t)}}),window.Progressbar=Progressbar,Keyshortcuts.prototype=Object.create(Eventsmanager.prototype),Object.assign(Keyshortcuts.prototype,{disabled:!1,disable:function(){this.disabled=!0},enable:function(){this.disabled=!1},isMac:function(){return-1!==navigator.appVersion.indexOf("Mac")},checkIfPressed:function(t,e){"use strict";return("optional"===t.metaKey||!!t.metaKey==!!e.metaKey)&&(("optional"===t.altKey||!!t.altKey==!!e.altKey)&&(("optional"===t.shiftKey||!!t.shiftKey==!!e.shiftKey)&&(("optional"===t.ctrlKey||!!t.ctrlKey==!!e.ctrlKey)&&t.keyCode===e.keyCode)))},onKeyDown:function(t){"use strict";if(this.disabled)return!1;var e,s;for(e=0;e<this.shortcuts.length;e+=1)(s=this.shortcuts[e]).pressed&&!s.repeatable||!this.checkIfPressed(s,t)||(s.pressed=!0,"function"==typeof s.callbackDown&&s.callbackDown(t))},onKeyUp:function(t){"use strict";if(this.disabled)return!1;var e,s;for(e=0;e<this.shortcuts.length;e+=1)(s=this.shortcuts[e]).pressed&&(this.checkIfPressed(s,t),1)&&(s.pressed=!1,"function"==typeof s.callbackUp&&s.callbackUp(t))},registerEvents:function(){"use strict";var e=this;window.addEventListener("keydown",function(t){if("INPUT"!==document.activeElement.tagName)return e.onKeyDown(t)}),window.addEventListener("keyup",function(t){if("INPUT"!==document.activeElement.tagName)return e.onKeyUp(t)})},getKeycodeStr:function(t){"use strict";var e;switch(t){case 32:e="space";break;case 91:e=this.isMac()?"":"WIN";break;case 18:e=this.isMac()?"":"ALT";break;case 16:e=this.isMac()?"":"SHIFT";break;case 17:e=this.isMac()?"ctrl":"CTRL";break;case 27:e="Esc";break;case 20:e=this.isMac()?"":"Caps lock";break;case 13:e="";break;case 8:e="";break;case 187:e="+";break;case 189:e="-";break;default:e=String.fromCharCode(t)}return e},getShortcutStr:function(t){"use strict";var e=[];return!0===t.metaKey&&e.push(this.isMac()?"":"WIN"),!0===t.altKey&&e.push(this.isMac()?"":"ALT"),!0===t.ctrlKey&&e.push(this.isMac()?"ctrl":"CTRL"),!0===t.shiftKey&&e.push(this.isMac()?"":"SHIFT"),t.keyCode&&e.push(this.getKeycodeStr(t.keyCode)),e.join(" + ")},addShortcut:function(t,e,s){"use strict";t.callbackDown=e,t.callbackUp=s,this.shortcuts.push(t)}}),window.Keyshortcuts=Keyshortcuts,Colorpalette.prototype=Object.create(Eventsmanager.prototype),Object.assign(Colorpalette.prototype,{normalize:function(t,e,s){"use strict";return t<e&&(t=e),s<t&&(t=s),t},pickPalette:function(t,e){"use strict";t=this.normalize(t,0,100),e=this.normalize(e,0,100),this.color.saturation=t,this.color.value=e;var s=this.HSVtoRGB(this.color.hue,this.color.saturation,this.color.value);this.setPalettePointer(this.color.saturation,this.color.value);var i=s;i.a=this.color.alpha,this.setColor(i)},changeHue:function(t){"use strict";(t%=360)<0&&(t+=360),this.setHueSlider(t),this.color.hue=t,this.drawPalette(t);var e=this.HSVtoRGB(t,this.color.saturation,this.color.value);e.a=this.color.alpha,this.setColor(e)},changeAlpha:function(t){"use strict";t=this.normalize(t,0,1),this.color.alpha=t,this.setAlpha(t)},focus:function(){"use strict";this.isFocused=!0},blur:function(){"use strict";this.isFocused=!1},getColor:function(){"use strict";return{red:parseInt(this.color.red,10),green:parseInt(this.color.green,10),blue:parseInt(this.color.blue,10),alpha:parseFloat(this.color.alpha)}},HSVtoRGB:function(t,e,s){"use strict";var i=s/100,o=e/100*i,r=t/60,a=o*(1-Math.abs(r%2-1)),n=i-o;return o=255*(o+n),a=255*(a+n),n*=255,0<=r&&r<1?{r:o,g:a,b:n}:1<=r&&r<2?{r:a,g:o,b:n}:2<=r&&r<3?{r:n,g:o,b:a}:3<=r&&r<4?{r:n,g:a,b:o}:4<=r&&r<5?{r:a,g:n,b:o}:5<=r&&r<6?{r:o,g:n,b:a}:{r:0,g:0,b:0}},RGBtoHSV:function(t,e,s){"use strict";var i,o=t/255,r=e/255,a=s/255,n=Math.max(o,r,a),l=n-Math.min(o,r,a),h=0,c=0;return l&&(n===o&&(h=(r-a)/l),n===r&&(h=2+(a-o)/l),n===a&&(h=4+(o-r)/l),n&&(c=l/n)),(i=60*h)<0&&(i+=360),{h:i,s:100*c,v:100*n}},putPixel:function(t,e,s,i){"use strict";var o=4*(e+s*t.width);t.data[o]=i.r,t.data[o+1]=i.g,t.data[o+2]=i.b,t.data[o+3]=i.a},drawHue:function(){"use strict";var t,e,s;for(t=0;t<this.hueCanvas.width;t+=1)for(e=0;e<this.hueCanvas.height;e+=1)s=this.HSVtoRGB(e/this.hueCanvas.height*360,100,100),this.putPixel(this.hueIData,t,e,{r:s.r,g:s.g,b:s.b,a:255});this.hueContext2d.putImageData(this.hueIData,0,0)},setAlphaSlider:function(t){"use strict";this.alphaSliderEl.style.left=this.alphaCanvas.width*(t/1)-.015*this.width+"px"},setAlpha:function(t){"use strict";t=Math.round(100*t)/100,this.color.alpha=t,this.setColor({r:this.color.red,g:this.color.green,b:this.color.blue,a:this.color.alpha})},setHueSlider:function(t){"use strict";this.hueSliderEl.style.top=this.height*(1/11)+this.hueCanvas.height*(t/360)-.015*this.height+"px"},setPalettePointer:function(t,e){"use strict";var s=this.paletteCanvas.width*(t/100),i=this.paletteCanvas.height*(e/100);this.palettePointerEl.style.left=.03*-this.width+s+"px",this.palettePointerEl.style.top=.03*-this.height+.1*this.height+i+"px"},triggerUpdate:function(){"use strict";var t=this.getColor();this.dispatch("change",{color:t})},updateFromInputs:function(){"use strict";this.setColor({r:this.redInput.value,g:this.greenInput.value,b:this.blueInput.value,a:this.alphaInput.value}),this.setAlpha(this.alphaInput.value)},setColor:function(t,e){"use strict";var s={h:this.color.hue,s:this.color.saturation,v:this.color.value};(t.r||t.g||t.b)&&(s=this.RGBtoHSV(t.r,t.g,t.b)),t.r===t.g&&t.g===t.b&&(s.h=this.color.hue),this.color.red=t.r,this.color.green=t.g,this.color.blue=t.b,this.color.alpha=t.a,this.color.hue=s.h,this.color.saturation=s.s,this.color.value=s.v,this.redInput.value=t.r,this.greenInput.value=t.g,this.blueInput.value=t.b,this.alphaInput.value=t.a,this.setHueSlider(s.h),this.drawPalette(s.h),this.darwAlpha(t),this.setAlphaSlider(t.a),this.setPalettePointer(s.s,s.v);var i=this.getColor();this.colorEl.style.backgroundColor="rgba("+i.red+","+i.green+","+i.blue+","+i.alpha+")",e||this.triggerUpdate()},drawPalette:function(t){"use strict";var e,s,i;for(e=0;e<this.paletteCanvas.width;e+=1)for(s=0;s<this.paletteCanvas.height;s+=1)i=this.HSVtoRGB(t,e/this.paletteCanvas.width*100,s/this.paletteCanvas.height*100),this.putPixel(this.paletteIData,e,s,{r:i.r,g:i.g,b:i.b,a:255});this.paletteContext2d.putImageData(this.paletteIData,0,0)},darwAlpha:function(t){"use strict";var e,s;for(e=0;e<this.alphaCanvas.width;e+=1)for(s=0;s<this.alphaCanvas.height;s+=1)this.putPixel(this.alphaIData,e,s,{r:t.r,g:t.g,b:t.b,a:e/this.alphaCanvas.width*255});this.alphaContext2d.putImageData(this.alphaIData,0,0)}}),window.Colorpalette=Colorpalette,Pixelpicker.prototype=Object.create(Eventsmanager.prototype),Object.assign(Pixelpicker.prototype,{normalize:function(t,e,s){"use strict";return t<e&&(t=e),s<t&&(t=s),t},setPalettePointer:function(t,e){"use strict";this.x=t,this.y=e,this.palettePointerEl.style.left=.03*-this.width+t+"px",this.palettePointerEl.style.top=.03*-this.height+.1*this.height+e+"px"},pickPalette:function(t,e){"use strict";console.log("pickPalette",t,e),t=this.normalize(t,0,this.width),e=this.normalize(e,0,this.height);var s=this.paletteContext2d.getImageData(t,e,1,1).data;this.setPalettePointer(t,e);var i={r:s[0],g:s[1],b:s[2],a:s[3]/255};this.setColor(i)},setThresholdSlider:function(t){"use strict";this.thresholdSliderEl.style.left=this.width*t-.015*this.width+"px"},setThreshold:function(t){"use strict";t=Math.round(100*t)/100,this.threshold=t,this.setThresholdSlider(t)},changeThreshold:function(t){"use strict";t=this.normalize(t,0,1),this.threshold=t,this.setThreshold(t)},focus:function(){"use strict";this.isFocused=!0},blur:function(){"use strict";this.isFocused=!1},getColor:function(){"use strict";return{red:parseInt(this.color.red,10),green:parseInt(this.color.green,10),blue:parseInt(this.color.blue,10),alpha:parseFloat(this.color.alpha)}},putPixel:function(t,e,s,i){"use strict";var o=4*(e+s*t.width);t.data[o]=i.r,t.data[o+1]=i.g,t.data[o+2]=i.b,t.data[o+3]=i.a},triggerUpdate:function(){"use strict";var t=this.getColor();this.dispatch("change",{color:t})},updateFromInputs:function(){"use strict";this.setColor({r:this.redInput.value,g:this.greenInput.value,b:this.blueInput.value,a:this.alphaInput.value}),this.setAlpha(this.alphaInput.value)},setColor:function(t,e){"use strict";this.color.red=t.r,this.color.green=t.g,this.color.blue=t.b,this.color.alpha=t.a,this.redInput.value=t.r,this.greenInput.value=t.g,this.blueInput.value=t.b,this.alphaInput.value=t.a;var s=this.getColor();this.colorEl.style.backgroundColor="rgba("+s.red+","+s.green+","+s.blue+","+s.alpha+")",e||this.triggerUpdate()}}),window.Pixelpicker=Pixelpicker,Sketch.prototype=Object.create(Eventsmanager.prototype),Object.assign(Sketch.prototype,{getHistoryStatus:function(){"use strict";return{undo:this.userBFramesCounter,redo:this.myStash.length}},getId:function(){"use strict";return String(this.config.sid)},setConfig:function(t){"use strict";this.config=Object.assign(this.config,t)},getConfig:function(){"use strict";return this.config},getPageConfig:function(t){"use strict";return this===t.room.sketch&&this.setConfig(t.getSketchConfig()),{description:"Drawing board sketch page",version:"0.5.1",timestamp:Date.now(),timestampISO:(new Date).toISOString(),host:document.location.host,cmd:"page",config:this.getConfig()}},getFrames:function(){"use strict";var t,e,s=this.framesHistory.concat(this.newFrames);for(t=0;t<s.length;t+=1)for(e=0;e<s[t].evs.length;e+=1)void 0!==s[t].evs[e].cid&&Object.assign(s[t].evs[e],this.getCachedFrame(s[t].evs[e].cid)),s[t].cmd="inputs",s[t].sid=this.getId();return s},cacheFrame:function(e){"use strict";var t=this.toolsCache.findIndex(function(t){return!!t&&(t.tol===e.tol&&t.vpx===e.vpx&&t.vpy===e.vpy&&t.scl===e.scl&&t.rot===e.rot&&t.hgt===e.hgt&&t.wdh===e.wdh&&JSON.stringify(t.cnf)===JSON.stringify(e.cnf))});return-1===t?(this.toolsCache.push({vpx:e.vpx,vpy:e.vpy,scl:e.scl,rot:e.rot,tol:e.tol,hgt:e.hgt,wdh:e.wdh,cnf:e.cnf}),this.toolsCache.length-1):t},getCachedFrame:function(t){"use strict";return this.toolsCache[t]},reset:function(){"use strict";this.toolsCache=[],this.myStash=[],this.framesHistory=[],this.newFrames=[],this.grindingThreshold=1e3/60},grindBulkFrame:function(t,e,s){"use strict";var i,o,r,a,n=this;function l(t,e){for(var s,i=0;t.pts.t[i]<=e;)i+=1;i<2&&(i=2);var o=(s={cid:n.cacheFrame(t),pts:{t:t.pts.t.splice(0,i),x:t.pts.x.splice(0,i),y:t.pts.y.splice(0,i)}}).pts.t[s.pts.t.length-1],r=s.pts.x[s.pts.x.length-1],a=s.pts.y[s.pts.y.length-1];return t.pts.t.unshift(o),t.pts.x.unshift(r),t.pts.y.unshift(a),s}if(this.bulkId+=1,t.UID===e.uid&&(this.userBFramesCounter||t.dispatch("undoAvaliable"),this.userBFramesCounter+=1),e.evs&&e.evs.length)for(;e.evs.length;){for(o=e.evs[0].pts.t[0]+this.grindingThreshold,i={uid:e.uid,bid:this.bulkId,evs:[]},r=e.evs.length-1;0<=r;r-=1)1<e.evs[r].pts.t.length&&(a=l(e.evs[r],o),i.evs.push(a)),e.evs[r].pts.t.length<2&&e.evs.splice(r,1);s?this.framesHistory.push(i):this.newFrames.push(i)}},getCommandsHist:function(){"use strict";return this.framesHistory},getCommandsCurrent:function(){"use strict";var t,e=this.newFrames.splice(0,1);if(e.length){for(t=0;t<e.length;t+=1)this.framesHistory.push(e[t]);return e}return[]},undoSketch:function(t,e){"use strict";var a=[],n=this;function s(t,e,s){var i,o,r=t.length;for(r-=1;-1<r;r-=1)if(!s&&t[r].uid===e||t[r].uid===e&&t[r].bid===s){for(s=(i=t.splice(r,1)[0]).bid,o=0;o<i.evs.length;o+=1)void 0!==i.evs[o].cid&&Object.assign(i.evs[o],n.getCachedFrame(i.evs[o].cid));a.push(i)}}return s(this.newFrames,e,!1),s(this.framesHistory,e,!1),t.UID===e&&a.length&&(this.userBFramesCounter-=1,0===this.userBFramesCounter&&t.dispatch("undoUnavaliable")),a},sendUndo:function(t){"use strict";t.sendMessageToServer({sid:this.getId(),cmd:"undo",uid:t.UID,user:{user_id:t.UID}})},undo:function(t){"use strict";t.sendInputs();var e=this.undoSketch(t,t.UID);this.sendUndo(t),t.planRefreshWindow(0,"undo"),this.myStash=this.myStash.concat(e),0<this.myStash.length&&t.dispatch("redoAvaliable")},redo:function(t){"use strict";if(this.myStash&&0<this.myStash.length){if(!this.myStash.length)return void console.warn("Redo stash empty!");var e=this.myStash.splice(-1)[0],s={uid:t.UID,ts:(new Date).getTime(),cmd:"inputs",evs:e.evs};t.sendMessageToServer(s),this.grindBulkFrame(t,e),0===this.myStash.length&&t.dispatch("redoUnavaliable")}else t.dispatch("redoUnavaliable")},destructor:function(){"use strict";this.reset()}}),Room.prototype={reset:function(){"use strict";var t;for(t=this.sketches.length-1;0<=t;t-=1)this.sketches[t].destructor(),this.sketches.splice(t,1);this.sketch=void 0},getSketchBySid:function(t){"use strict";var e;for(e=0;e<this.sketches.length;e+=1)if(this.sketches[e].getId()===t)return this.sketches[e];return!1},getSketchByNo:function(t){"use strict";var e=parseInt(t,10)-1;return this.sketches[e]},getCurrentSketchNo:function(){"use strict";return this.sketches.indexOf(this.sketch)+1},addSketch:function(t,e){"use strict";if(t.sendInputs(),t.drawInputs(),this.totalCount+=1,!e)throw new Error("Room.addSketch - config param is required");var s=new Sketch(e=Object.assign({titleNo:this.totalCount},e));return this.sketches.push(s),t.dispatch("sketch-added",s),s},setPageConfig:function(t,e){"use strict";var s;return e.sid&&(s=this.getSketchBySid(e.sid)),s?(this.sketch===s&&this.sketch.setConfig(t.getSketchConfig()),s.setConfig(e),this.sketch===s&&t.setSketchConfig(s.getConfig()),t.dispatch("sketch-changed",s)):s=this.addSketch(t,e,"remoteFlag"),this.sketch||this.setActiveSketch(t,s),s},setActiveSketch:function(t,e){"use strict";e instanceof Sketch?(t.sendInputs(),t.drawInputs(),this.sketch&&(this.sketch.setConfig(t.getSketchConfig()),this.prevSketch.push(this.sketch)),this.sketch=e,t.setSketchConfig(e.getConfig()),t.dispatch("sketch-changed",e),t.dispatch("historySketch-status",e.getHistoryStatus()),t.planRefreshWindow(0,"room.js:setActiveSketch")):console.error("sketchpad.room.js","setActiveSketch(sketchpad, sketch) - sketch instanceof Sketch is required")},removeSketch:function(t,e,s){"use strict";if(s||t.canDraw()){if(!(e instanceof Sketch))throw new Error("sketchpad.room.js:removeSketch(sketchpad, sketch, remoteRemoveFlag), sketch must be instanceof Sketch");var i;for(t.sendInputs(),t.drawInputs(),i=this.prevSketch.length-1;0<=i;i-=1)this.prevSketch[i]===e&&this.prevSketch.splice(i,1);for(i=this.sketches.length-1;0<=i;i-=1)this.sketches[i]===e&&this.sketches.splice(i,1);this.sketch===e&&(0<this.prevSketch.length?(this.sketch=this.prevSketch.pop(),t.setSketchConfig(this.sketch.getConfig()),t.dispatch("sketch-changed",this.sketch)):0<this.sketches.length?(this.sketch=this.sketches[0],t.dispatch("sketch-changed",this.sketch),t.setSketchConfig(this.sketch.getConfig())):(this.sketch=null,t.setSketchConfig({}))),t.dispatch("sketch-removed",e),s||t.sendMessageToServer({cmd:"remove-page",sid:e.getId()}),t.planRefreshWindow(0,"room.js:removeSketch")}else console.error("Insufficient permissions to perform `removeSketch` operation")},addClient:function(t){var e=t.user_color||{r:Math.round(25+205*Math.random()),g:Math.round(25+205*Math.random()),b:Math.round(25+205*Math.random())},s=document.createElement("div"),i=document.createElement("div"),o=document.createElement("div");o.style.display="none",o.style.backgroundColor="rgba("+e.r+", "+e.g+", "+e.b+", 0.5)",o.style.position="absolute",o.style.borderRadius="50%",o.style.marginLeft="-5px",o.style.marginTop="-5px",o.style.width="10px",o.style.height="10px",i.className="username",i.textContent="New ID: "+t.user_id,i.style.backgroundColor="rgba("+e.r+", "+e.g+", "+e.b+", 1)",i.style.color="#FFF",i.style.fontSize="12px",s.appendChild(o),s.appendChild(i),s.className="viewport",s.style.position="absolute",s.style.overflow="hidden",s.style.border="1px solid rgba("+e.r+", "+e.g+", "+e.b+", 1)",s.style.boxSizing="border-box",t.pointerEl=o,t.viewportEl=s,this.setViewport(s,t,this.sketchpad),this.sketchpad.hudsEl.appendChild(t.viewportEl),this.clients.push(t),this.redrawViewports()},setViewportPointer:function(t,e,s){"use strict";var i=this.getClientById(t);i&&(i.pointerEl.style.display="block",i.pointerEl.style.left=e+"px",i.pointerEl.style.top=s+"px")},setViewport:function(t,e,s){"use strict";if(this.sketch instanceof Sketch){var i=e.viewport;i.sid!==s.room.sketch.getId()?t.style.display="none":t.style.display="block",e.user_id===s.user.user_id&&(t.style.border="none",t.style.zIndex=2),t.querySelector(".username").textContent=(e.viewport.away?"[Away]":"")+" "+e.user_name,t.style.top="0px",t.style.left="0px",t.style.width=i.width+"px",t.style.height=i.height+"px",t.style.transformOrigin=i.x+"px "+i.y+"px",t.style.webkitTransformOrigin=i.x+"px "+i.y+"px",t.style.MozTransformOrigin=i.x+"px "+i.y+"px",t.style.msTransformOrigin=i.x+"px "+i.y+"px",t.style.OTransformOrigin=i.x+"px "+i.y+"px";var o="translate("+s.width/2+"px,"+s.height/2+"px) scale("+1/i.scale+") rotate("+-1*i.rotation+"deg) translate("+i.x+"px, "+i.y+"px) translate("+-i.width/2+"px, "+-i.height/2+"px)";t.style.transform=o,t.style.webkitTransform=o,t.style.MozTransform=o,t.style.msTransform=o,t.style.OTransform=o}},redrawViewports:function(){"use strict";var e=this;this.clients.forEach(function(t){e.setViewport(t.viewportEl,t,e.sketchpad)})},updateClient:function(t){"use strict";var e,s;for(e=0;e<this.clients.length;e+=1)(s=this.clients[e]).user_id===t.user_id&&(s.webrtc=t.webrtc,s.viewport=t.viewport);this.redrawViewports()},getClientById:function(t){"use strict";var e,s;for(e=this.clients.length-1;0<=e;e-=1)if(s=this.clients[e],String(s.user_id)===String(t))return s},removeClientById:function(t){"use strict";console.warn("Removing user",t);var e,s;for(e=this.clients.length-1;0<=e;e-=1)s=this.clients[e],String(s.user_id)===String(t)&&(this.sketchpad.hudsEl.removeChild(s.viewportEl),this.clients.splice(e,1))}},Input.prototype={instance:0,getConfig:function(){"use strict";return{lay:this.layers.slice(),siz:this.size,col:this.color,fcl:this.fillColor,txt:this.textContent,fnt:this.font,axs:this.axis,tst:1,url:this.url,cen:this.center,mrh:this.mirrorH,mrv:this.mirrorV,mvh:this.mirrorVH,rbw:this.rainbow}},addPoint:function(t,e,s,i){"use strict";this.sketchpad.readOnly||(e!==this.lastX||s!==this.lastY||i)&&(this.lastT=t-this.timestamp,this.lastX=e,this.lastY=s,this.listT.push(t-this.timestamp),this.listX.push(e),this.listY.push(s))},getLastPoint:function(){"use strict";return!!this.listX.length&&{x:this.listX[this.listX.length-1],y:this.listY[this.listY.length-1]}},getPointsToSend:function(){"use strict";var t;if(this.lastSendPointer<this.listX.length-1){var e=this.listT[this.lastSendPointer],s=this.listT.slice(this.lastSendPointer),i=this.listX.slice(this.lastSendPointer),o=this.listY.slice(this.lastSendPointer);for(this.lastSendPointer=this.listX.length-1,t=0;t<s.length;t+=1)s[t]-=e;return{t:s,x:i,y:o}}},getPointsToDraw:function(){"use strict";if(this.lastDrawPointer<this.listX.length-1){var t=this.listX.slice(this.lastDrawPointer),e=this.listY.slice(this.lastDrawPointer),s=this.listT.slice(this.lastDrawPointer);return this.lastDrawPointer=this.listX.length-1,{t:s,x:t,y:e}}}},Tool.prototype=Object.create(Eventsmanager.prototype),Tool.prototype=Object.assign(Tool.prototype,{sketchpad:"error: undefined sketchpad object",layers:["F"],toolLabel:"Default tool",toolId:"default_tool_class",lineWidth:1,minSize:.1,maxSize:100,maxLayers:1,color:{r:0,g:0,b:0,a:1},getCursor:function(){"use strict";var t=parseInt(this.getSize()+1,10);return{pointer:"crosshair",marginLeft:-t/2+"px",marginTop:-t/2+"px",width:t+"px",height:t+"px",border:"1px solid black",boxSizing:"border-box",borderRadius:"50%",backgroundColor:"rgba(0,0,0,0)"}},getToolConfig:function(){"use strict";return{toolId:this.toolId,layers:this.layers,lineWidth:this.lineWidth,maxLayers:this.maxLayers,color:this.getColorStr()}},setToolConfig:function(t){"use strict";var e,s;if(Array.isArray(t.layers)&&(this.layers=t.layers),t.color)switch(typeof t.color){case"string":e=String(t.color).match(/([0-9]+),([0-9]+),([0-9]+),([0-9\.]+)/),s={r:parseInt(e&&e[1])||0,g:parseInt(e&&e[2])||0,b:parseInt(e&&e[3])||0,a:parseFloat(e&&e[4])||0},this.setColor(s.r,s.g,s.b,s.a);break;case"object":this.setColor(t.color.r,t.color.g,t.color.b,t.color.a)}return parseFloat(t.lineWidth)&&this.setSize(parseFloat(t.lineWidth)),this.dispatch("changeParams"),this},distance:function(t,e,s,i){"use strict";return Math.sqrt(Math.pow(Math.abs(t-s),2)+Math.pow(Math.abs(e-i),2))},rotate:function(t,e){"use strict";return t=2*Math.PI*(t/360),e={x:Math.cos(t)*e.x-Math.sin(t)*e.y,y:Math.sin(t)*e.x+Math.cos(t)*e.y}},setColor:function(t,e,s,i){"use strict";return void 0===i&&(i=this.color.a),this.color={r:t,g:e,b:s,a:i},this.dispatch("changeParams"),this},getColor:function(){"use strict";return this.color},getColorStr:function(){"use strict";return"rgba("+this.color.r+","+this.color.g+","+this.color.b+","+this.color.a+")"},setSize:function(t){"use strict";return this.lineWidth=parseFloat(t),this.dispatch("changeParams"),this},getSize:function(){"use strict";return this.lineWidth},startInput:function(t,e,s,i){"use strict";i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=new Input({sketchpad:this.sketchpad,id:t,tool:this.toolId,layers:this.layers,color:this.getColorStr(),size:this.lineWidth});return o.addPoint((new Date).getTime(),e,s),o.addPoint((new Date).getTime(),e,s,"force"),o},moveInput:function(t,e,s,i){"use strict";if(i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10)),i&&i.shiftKey){var o=t.getLastPoint();if(o&&(Math.abs(o.x-e)<10&&(e=o.x),Math.abs(o.y-s)<10&&(s=o.y),o.x===e&&o.y===s))return!1}t.addPoint((new Date).getTime(),e,s,i)},finishInput:function(t,e,s,i){"use strict";i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10)),t.addPoint((new Date).getTime(),e,s)},drawFramePath:function(t,e){"use strict";var s,i,o,r=this.sketchpad,a=t.cnf;if(a.lay&&a.lay.length)for(o=0;o<a.lay.length;o+=1){switch(a.lay[o]){case r.LAYER_BACK:s=r.contextB2D;break;case r.LAYER_FRONT:s=r.context2D;break;default:s=r.context2D}if(s.save(),s.rotate(r.rotation*Math.PI/180),s.scale(r.scale,r.scale),s.translate(t.vpx,t.vpy),s.translate(-r.viewportX,-r.viewportY),s.scale(1/t.scl,1/t.scl),s.rotate(-t.rot*Math.PI/180),e&&e.x&&1<e.x.length){for(s.beginPath(),s.lineCap="round",s.lineJoin="round",s.strokeStyle=a.col,s.lineWidth=a.siz,s.moveTo(e.x[0],e.y[0]),i=1;i<e.x.length;i+=1)s.lineTo(e.x[i],e.y[i]);s.stroke()}s.restore()}else console.warn("no layers to draw")}}),NSSketchpad.avaliableTools.push(Tool),ToolFillable.prototype=Object.create(Tool.prototype),Object.assign(ToolFillable.prototype,{toolLabel:"_fillable class",toolId:"_fillable class",fillColor:{r:128,g:0,b:128,a:.1},getToolConfig:function(){"use strict";var t=Tool.prototype.getToolConfig.call(this);return Object.assign(t,{fillColor:this.getFillColorStr()})},setToolConfig:function(t){"use strict";var e,s;if(Tool.prototype.setToolConfig.call(this,t),t.fillColor)switch(typeof t.fillColor){case"string":e=String(t.fillColor).match(/([0-9]+),([0-9]+),([0-9]+),([0-9\.]+)/),s={r:parseInt(e&&e[1])||0,g:parseInt(e&&e[2])||0,b:parseInt(e&&e[3])||0,a:parseFloat(e&&e[4])||0},this.setFillColor(s.r,s.g,s.b,s.a);break;case"object":this.setFillColor(t.fillColor.r,t.fillColor.g,t.fillColor.b,t.fillColor.a)}return this.dispatch("changeParams"),this},setFillColor:function(t,e,s,i){"use strict";return void 0===i&&(i=this.fillColor.a),this.fillColor={r:t,g:e,b:s,a:i},this.dispatch("changeParams"),this},getFillColor:function(){"use strict";return this.fillColor},getFillColorStr:function(){"use strict";return"rgba("+this.fillColor.r+","+this.fillColor.g+","+this.fillColor.b+","+this.fillColor.a+")"}}),ToolCirc.prototype=Object.create(ToolFillable.prototype),Object.assign(ToolCirc.prototype,{lineWidth:1,toolLabel:"Circle",layers:["F"],toolId:"circle",keyCode:67,color:{r:0,g:0,b:0,a:1},fillColor:{r:255,g:127,b:0,a:0},startInput:function(t,e,s,i){"use strict";i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=this.sketchpad,r=new Input({sketchpad:o,id:t,tool:this.toolId,color:this.getColorStr(),fillColor:this.getFillColorStr(),size:this.lineWidth,layers:this.layers,uid:this.sketchpad.UID});return r.firstX=e,r.firstY=s,r.selectorDiv=document.createElement("div"),r.selectorDiv.style.position="absolute",r.selectorDiv.style.border="1px solid white",r.selectorDiv.style.borderRadius="50%",r.selectorDiv.style.display="block",this.sketchpad.centerViewport?(r.selectorDiv.style.left=this.sketchpad.width/2+e-1+"px",r.selectorDiv.style.top=this.sketchpad.height/2+s-1+"px"):(r.selectorDiv.style.left=e-1+"px",r.selectorDiv.style.top=s-1+"px"),r.selectorDiv.style.width="1px",r.selectorDiv.style.height="1px",r.selectorDiv2=document.createElement("div"),r.selectorDiv2.style.position="absolute",r.selectorDiv2.style.border="1px dashed black",r.selectorDiv2.style.borderRadius="50%",r.selectorDiv2.style.display="block",this.sketchpad.centerViewport?(r.selectorDiv2.style.left=this.sketchpad.width/2+e-1+"px",r.selectorDiv2.style.top=this.sketchpad.height/2+s-1+"px"):(r.selectorDiv2.style.left=e-1+"px",r.selectorDiv2.style.top=s-1+"px"),r.selectorDiv2.style.width="1px",r.selectorDiv2.style.height="1px",o.containerEl.appendChild(r.selectorDiv),o.containerEl.appendChild(r.selectorDiv2),r.addPoint((new Date).getTime(),e,s),r},moveInput:function(t,e,s,i){"use strict";i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=t.firstX,r=t.firstY,a=Math.abs(e-o),n=Math.abs(s-r);i.shiftKey&&(a=n),this.sketchpad.centerViewport?(t.selectorDiv.style.left=this.sketchpad.width/2+o-a+"px",t.selectorDiv.style.top=this.sketchpad.height/2+r-n+"px",t.selectorDiv2.style.left=this.sketchpad.width/2+o-a+"px",t.selectorDiv2.style.top=this.sketchpad.height/2+r-n+"px"):(t.selectorDiv.style.left=o-a+"px",t.selectorDiv.style.top=r-n+"px",t.selectorDiv2.style.left=o-a+"px",t.selectorDiv2.style.top=r-n+"px"),t.selectorDiv.style.width=2*a+"px",t.selectorDiv.style.height=2*n+"px",t.selectorDiv2.style.width=2*a+"px",t.selectorDiv2.style.height=2*n+"px"},finishInput:function(t,e,s,i){"use strict";i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=this.sketchpad,r=t.firstX,a=t.firstY,n=Math.abs(s-a);i.shiftKey&&(e=r+n),t.addPoint((new Date).getTime(),e,s),o.containerEl.removeChild(t.selectorDiv),o.containerEl.removeChild(t.selectorDiv2)},recalcS:function(t,e){"use strict";var s=this.sketchpad;return e*=1/t.scl,e*=s.scale},drawFramePath:function(t,e){"use strict";var s,i,o,r,a,n=t.cnf,l=this.sketchpad;if(n.lay&&n.lay.length)for(s=0;s<n.lay.length;s+=1){switch(n.lay[s]){case l.LAYER_BACK:o=l.contextB2D;break;case l.LAYER_FRONT:o=l.context2D;break;default:o=l.context2D}o.save(),o.rotate(l.rotation*Math.PI/180),o.scale(l.scale,l.scale),o.translate(t.vpx,t.vpy),o.translate(-l.viewportX,-l.viewportY),o.scale(1/t.scl,1/t.scl),o.rotate(-t.rot*Math.PI/180),r={x:e.x[0],y:e.y[0]},a={x:e.x[1],y:e.y[1]},o.translate(r.x,r.y),o.beginPath(),o.scale(1,Math.abs(a.y-r.y)/Math.abs(a.x-r.x)),i=Math.abs(a.x-r.x),o.arc(0,0,i,0,2*Math.PI,!1),o.restore(),o.strokeStyle=n.col,o.fillStyle=n.fcl,o.lineWidth=this.recalcS(t,n.siz),o.fill(),o.stroke(),o.restore()}else console.warn("no layers to draw")}}),NSSketchpad.avaliableTools.push(ToolCirc),ToolColorpicker.prototype=Object.create(ToolFillable.prototype),Object.assign(ToolColorpicker.prototype,{maxLayers:0,keyCode:73,toolLabel:"Colorpicker",toolId:"colorpicker",color:{r:128,g:128,b:128,a:0},getCursor:function(){"use strict";return{pointer:"none",marginLeft:"-5px",marginTop:"-5px",width:"10px",height:"10px",borderRadius:"50%",border:"1px solid black",backgroundColor:this.getColorStr()}},startInput:function(t,e,s,i){"use strict";var o=this.sketchpad,r=new Input({sketchpad:o,id:t,tool:this.toolId}),a=this.sketchpad.colorPicker(e,s);return i.shiftKey||2===i.button?(this.fillColorChanged=!0,this.setFillColor(a.r,a.g,a.b,a.a)):(this.colorChanged=!0,this.setColor(a.r,a.g,a.b,a.a)),r.tmpCursor=this.sketchpad.containerEl.style.cursor,o.containerEl.style.cursor="crosshair",r},moveInput:function(t,e,s,i){"use strict";var o=this.sketchpad.colorPicker(e,s);return 2===i.button&&(i.preventDefault(),i.stopPropagation()),i.shiftKey||2===i.button?(this.fillColorChanged=!0,this.setFillColor(o.r,o.g,o.b,o.a)):(this.colorChanged=!0,this.setColor(o.r,o.g,o.b,o.a)),t},finishInput:function(t,e,s,i){"use strict";var o=this.sketchpad.colorPicker(e,s);return 2===i.button&&(i.preventDefault(),i.stopPropagation()),i.shiftKey||2===i.button?(this.fillColorChanged=!0,this.setFillColor(o.r,o.g,o.b,o.a)):(this.colorChanged=!0,this.setColor(o.r,o.g,o.b,o.a)),this.sketchpad.containerEl.style.cursor=t.tmpCursor,t},drawFramePath:function(){}}),NSSketchpad.avaliableTools.push(ToolColorpicker),ToolCustom.prototype=Object.create(Tool.prototype),Object.assign(ToolCustom.prototype,{toolId:"custom",lineWidth:10,keyCode:88,toolLabel:"Custom tool",drawFramePath:function(t,e){"use strict";var s,i,o,r,a,n=t.cnf,l=this.sketchpad;if(o=null,n.lay&&n.lay.length)for(i=0;i<n.lay.length;i+=1){switch(n.lay[i]){case l.LAYER_BACK:o=l.contextB2D;break;case l.LAYER_FRONT:o=l.context2D;break;default:o=l.context2D}if(o.save(),o.rotate(l.rotation*Math.PI/180),o.scale(l.scale,l.scale),o.translate(t.vpx,t.vpy),o.translate(-l.viewportX,-l.viewportY),o.scale(1/t.scl,1/t.scl),o.rotate(-t.rot*Math.PI/180),e&&e.x&&e.y&&1<e.x.length)for(s=1;s<e.x.length;s+=1)r={x:e.x[s-1],y:e.y[s-1]},a={x:e.x[s],y:e.y[s]},o.beginPath(),o.strokeStyle=this.getColorStr(),o.lineCap="miter",o.lineJoin="miter",o.lineWidth=n.siz+100/(10+this.distance(r.x,r.y,a.x,a.y)),o.moveTo(r.x,r.y),o.lineTo(a.x,a.y),o.stroke();o.restore()}else console.warn("no layers to draw")}}),NSSketchpad.avaliableTools.push(ToolCustom),ToolCutout.prototype=Object.create(Tool.prototype),Object.assign(ToolCutout.prototype,{maxLayers:"*",toolId:"cutout",layers:["F","B"],toolLabel:"Cut-out",getCursor:function(){"use strict";return{pointer:"crosshair",borderRadius:0,backgroundColor:"rgba(0,0,0,0)",border:"none"}},startInput:function(t,e,s,i){"use strict";i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=this.sketchpad,r=new Input({sketchpad:o,id:t,tool:this.toolId,layers:this.layers});return r.selectorDiv=document.createElement("div"),r.selectorDiv.style.position="absolute",r.selectorDiv.style.border="1px solid #f00",r.selectorDiv.style.display="block",this.sketchpad.centerViewport?(r.selectorDiv.style.left=this.sketchpad.width/2+e+"px",r.selectorDiv.style.top=this.sketchpad.height/2+s+"px"):(r.selectorDiv.style.left=e+"px",r.selectorDiv.style.top=s+"px"),r.selectorDiv.style.width="1px",r.selectorDiv.style.height="1px",r.selectorDiv.style.background="#f88",r.selectorDiv.style.opacity="0.3",o.containerEl.appendChild(r.selectorDiv),r.addPoint((new Date).getTime(),e,s),r},moveInput:function(t,e,s,i){"use strict";i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=t.listX[0],r=t.listY[0],a=Math.min(o,e),n=Math.min(r,s),l=Math.max(o,e),h=Math.max(r,s);this.sketchpad.centerViewport?(t.selectorDiv.style.left=this.sketchpad.width/2+a+"px",t.selectorDiv.style.top=this.sketchpad.height/2+n+"px"):(t.selectorDiv.style.left=a+"px",t.selectorDiv.style.top=n+"px"),t.selectorDiv.style.width=l-a+"px",t.selectorDiv.style.height=h-n+"px"},finishInput:function(t,e,s,i){"use strict";i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=this.sketchpad;t.addPoint((new Date).getTime(),e,s),o.containerEl.removeChild(t.selectorDiv)},drawFramePath:function(t,e){"use strict";var s,i,o=t.cnf,r=this.sketchpad;if(o.lay&&o.lay.length)for(s=0;s<o.lay.length;s+=1){switch(o.lay[s]){case r.LAYER_BACK:i=r.contextB2D;break;case r.LAYER_FRONT:i=r.context2D}i.save(),i.rotate(r.rotation*Math.PI/180),i.scale(r.scale,r.scale),i.translate(t.vpx,t.vpy),i.translate(-r.viewportX,-r.viewportY),i.scale(1/t.scl,1/t.scl),i.rotate(-t.rot*Math.PI/180),i.clearRect(e.x[0],e.y[0],e.x[1]-e.x[0],e.y[1]-e.y[0]),i.restore()}else console.warn("no layers to draw")}}),NSSketchpad.avaliableTools.push(ToolCutout),ToolEraser.prototype=Object.create(Tool.prototype),Object.assign(ToolEraser.prototype,{toolId:"eraser",maxLayers:"*",layers:["F","B"],lineWidth:16,minSize:2,maxSize:200,toolLabel:"Eraser",getCursor:function(){"use strict";var t=parseInt(this.getSize()+1,10);return{pointer:"crosshair",marginLeft:-t/2+"px",marginTop:-t/2+"px",width:t+"px",height:t+"px",border:"1px solid black",boxSizing:"border-box",borderRadius:"50%",backgroundColor:"rgba(255,255,255,.5)"}},drawFramePath:function(t,e){"use strict";var s,i,o,r,a,n=t.cnf,l=this.sketchpad;if(o=null,n.lay&&n.lay.length)for(i=0;i<n.lay.length;i+=1){switch(n.lay[i]){case l.LAYER_BACK:o=l.contextB2D;break;case l.LAYER_FRONT:o=l.context2D}if(o.save(),o.globalCompositeOperation="destination-out",o.rotate(l.rotation*Math.PI/180),o.scale(l.scale,l.scale),o.translate(t.vpx,t.vpy),o.translate(-l.viewportX,-l.viewportY),o.scale(1/t.scl,1/t.scl),o.rotate(-t.rot*Math.PI/180),e&&e.x&&e.y&&1<e.x.length)for(s=1;s<e.x.length;s+=1)r={x:e.x[s-1],y:e.y[s-1]},a={x:e.x[s],y:e.y[s]},o.beginPath(),o.strokeStyle=this.getColorStr(r.x,r.y),o.lineCap="miter",o.lineJoin="miter",o.lineWidth=n.siz,o.moveTo(r.x,r.y),o.lineTo(a.x,a.y),o.stroke();o.restore()}else console.warn("no layers to draw")}}),NSSketchpad.avaliableTools.push(ToolEraser),ToolHighlighter.prototype=Object.create(Tool.prototype),Object.assign(ToolHighlighter.prototype,{toolId:"highlighter",color:{r:255,g:255,b:15,a:.5},layers:["B"],lineWidth:16,keyCode:72,toolLabel:"Highlighter",getCursor:function(){"use strict";var t=parseInt(this.getSize(),10);return{pointer:"none",marginLeft:-(t=t/2+t/(t/5+0))/2+"px",marginTop:-t/2+"px",width:t+"px",height:t+"px",border:"none",borderRadius:0,backgroundColor:this.getColorStr()}},drawFramePath:function(t,e){"use strict";var s,i,o,r,a,n=this.sketchpad,l=t.cnf;if(l.lay&&l.lay.length)for(o=0;o<l.lay.length;o+=1){switch(l.lay[o]){case n.LAYER_BACK:s=n.contextB2D;break;case n.LAYER_FRONT:s=n.context2D;break;default:s=n.context2D}if(s.save(),s.lineCap="butt",s.lineJoin="round",s.rotate(n.rotation*Math.PI/180),s.scale(n.scale,n.scale),s.translate(t.vpx,t.vpy),s.translate(-n.viewportX,-n.viewportY),s.scale(1/t.scl,1/t.scl),s.rotate(-t.rot*Math.PI/180),s.strokeStyle=l.col,s.fillStyle=l.col,s.lineWidth=l.siz,e&&e.x&&1<e.x.length)for(i=1;i<e.x.length;i+=1)r={x:e.x[i-1],y:e.y[i-1]},a={x:e.x[i],y:e.y[i]},s.beginPath(),s.lineWidth=l.siz/2+l.siz/(l.siz/5+this.distance(r.x,r.y,a.x,a.y)/10),s.moveTo(r.x,r.y),s.lineTo(a.x,a.y),s.stroke(),s.arc(e.x[i],e.y[i],5,0,2*Math.PI,1),s.fill();s.restore()}else console.warn("no layers to draw")}}),NSSketchpad.avaliableTools.push(ToolHighlighter),ToolImage.prototype=Object.create(Tool.prototype),Object.assign(ToolImage.prototype,{layers:["F"],toolLabel:"Image",toolId:"image",keyCode:79,disabled:!1,fieldThreshold:100,disable:function(){"use strict";this.disabled=!0},enable:function(){"use strict";this.disabled=!1},getCursor:function(){"use strict";return{pointer:"crosshair",backgroundColor:"rgba(0,0,0,0)",borderRadius:"0",border:"none"}},onImagehostError:function(t){"use strict";popnotifications.notification(t.title,t.message)},onImagehostReady:function(t,e,s,i,o,r){"use strict";var a=new Input({sketchpad:this.sketchpad,id:777,tool:this.toolId,layers:this.layers,url:t,center:r});(this.sketchpad.inputs[777]=a).addPoint((new Date).getTime(),e,s),a.addPoint((new Date).getTime(),i,o,"force"),this.sketchpad.sendInputs(),this.sketchpad.drawInputs(),delete this.sketchpad.inputs[777]},startInput:function(t,e,s,i){"use strict";i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=this.sketchpad,r=new Input({sketchpad:o,id:t,tool:this.toolId,layers:this.layers});return r.firstX=e,r.firstY=s,r.selectorDiv=document.createElement("div"),r.selectorDiv.style.position="absolute",r.selectorDiv.style.border="1px solid black",r.selectorDiv.style.outline="1px dashed white",r.selectorDiv.style.outlineOffset="-1px",r.selectorDiv.style.display="block",this.sketchpad.centerViewport?(r.selectorDiv.style.left=this.sketchpad.width/2+e+"px",r.selectorDiv.style.top=this.sketchpad.height/2+s+"px"):(r.selectorDiv.style.left=e+"px",r.selectorDiv.style.top=s+"px"),r.selectorDiv.style.width="1px",r.selectorDiv.style.height="1px",o.containerEl.appendChild(r.selectorDiv),r},moveInput:function(t,e,s,i){"use strict";i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=t.firstX,r=t.firstY;Math.abs(o-e)<this.fieldThreshold||Math.abs(r-s)<this.fieldThreshold?Math.abs(o-e)<Math.abs(r-s)?(t.selectorDiv.style.background="linear-gradient(to right, rgba(0,0,0,.2), transparent)",t.selectorDiv.style.border="1px dashed #888",t.selectorDiv.style.boxSizing="border-box",t.selectorDiv.style.borderRight="",t.selectorDiv.style.outline="",e=o+100):(t.selectorDiv.style.background="linear-gradient(to bottom, rgba(0,0,0,.2), transparent)",t.selectorDiv.style.border="1px dashed #888",t.selectorDiv.style.boxSizing="border-box",t.selectorDiv.style.borderBottom="",t.selectorDiv.style.outline="",s=r+100):(t.selectorDiv.style.outline="1px dashed white",t.selectorDiv.style.border="1px solid black",t.selectorDiv.style.boxSizing="",t.selectorDiv.style.background="",t.selectorDiv.style.filter="");var a=Math.abs(s-r);i.shiftKey&&(e=e<o?o-a:o+a);var n=Math.min(o,e),l=Math.min(r,s),h=Math.max(o,e);a=Math.max(r,s)-l;var c=h-n;this.sketchpad.centerViewport?(t.selectorDiv.style.left=this.sketchpad.width/2+n-1+"px",t.selectorDiv.style.top=this.sketchpad.height/2+l-1+"px"):(t.selectorDiv.style.left=n+"px",t.selectorDiv.style.top=l+"px"),t.selectorDiv.style.width=c+"px",t.selectorDiv.style.height=a+"px"},finishInput:function(t,e,s,i){"use strict";i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=this.sketchpad,r=t.firstX,a=t.firstY;(Math.abs(r-e)<this.fieldThreshold||Math.abs(a-s)<this.fieldThreshold)&&(Math.abs(r-e)<Math.abs(a-s)?e=r:s=a);var n=Math.abs(s-a);i.shiftKey&&(e=e<r?r-n:r+n);var l=document.createElement("input");l.type="file",l.style.position="fixed",l.style.display="none",l.accept=".jpg,.jpeg,.png,.gif,.svg,image/*;capture=camera",l.click();var h=this;function c(t){h.onImagehostReady(t.url,r,a,e,s)}l.addEventListener("change",function(t){var e,s,i=t.target.files;for(e=0;e<i.length;e+=1)s=i[e],window.tmp=new Imagehost({progressParentEl:o.progressParentEl||o.containerEl,file:s}).on("success",c).on("error",h.onImagehostError.bind(h))}),o.containerEl.removeChild(t.selectorDiv)},drawFramePath:function(e,s){"use strict";var i,o,r=e.cnf,a=this.sketchpad;if(r&&r.lay&&r.lay.length){var n,l,h,c,d=this;r.url?a.resources.getImage(r.url,function(t){t.success&&p(t.img)},function(t){console.warn("error loading image",r.url,t),d.emptyImage.complete&&d.emptyImage.naturalWidth?p(d.emptyImage):d.emptyImage.addEventListener("load",function(){p(d.emptyImage)})}):console.log("error url")}else console.warn("no layers to draw");function p(t){for(i=0;i<r.lay.length;i+=1){switch(r.lay[i]){case a.LAYER_BACK:o=a.contextB2D;break;case a.LAYER_FRONT:o=a.context2D;break;default:o=a.context2D}o.save(),o.beginPath(),o.rotate(a.rotation*Math.PI/180),o.scale(a.scale,a.scale),o.translate(e.vpx,e.vpy),o.translate(-a.viewportX,-a.viewportY),o.scale(1/e.scl,1/e.scl),o.rotate(-e.rot*Math.PI/180),n={x:Math.min(s.x[0],s.x[1]),y:Math.min(s.y[0],s.y[1])},l={x:Math.max(s.x[0],s.x[1]),y:Math.max(s.y[0],s.y[1])},h=l.x-n.x,c=l.y-n.y,h<1&&c<1&&(h=t.width,c=t.height),h<1&&(h=t.width*(c/t.height)),c<1&&(c=t.height*(h/t.width)),r.cen&&(n.x-=t.width/2,n.y-=t.height/2),o.drawImage(t,n.x,n.y,h,c),o.restore()}}}}),NSSketchpad.avaliableTools.push(ToolImage),ToolLine.prototype=Object.create(Tool.prototype),Object.assign(ToolLine.prototype,{color:{r:0,g:0,b:0,a:1},toolLabel:"Line",toolKey:"l",toolId:"line",lineWidth:1,keyCode:76,startInput:function(t,e,s,i){"use strict";i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=this.sketchpad,r=new Input({sketchpad:o,id:t,tool:this.toolId,color:this.getColorStr(),size:this.lineWidth,layers:this.layers});r.selectorDiv=document.createElement("div"),r.selectorDiv.style.position="absolute",r.selectorDiv.style.display="block",r.selectorDiv.style.backgroundColor=this.getColorStr(),this.sketchpad.centerViewport?(r.selectorDiv.style.left=this.sketchpad.width/2+e+"px",r.selectorDiv.style.top=this.sketchpad.height/2+s+"px"):(r.selectorDiv.style.left=e+"px",r.selectorDiv.style.top=s+"px"),r.selectorDiv.style.width="1px";var a=this.getSize();return a<1&&(r.selectorDiv.style.borderTop="1px dashed "+this.getColorStr()),r.selectorDiv.style.height=a+"px",r.startX=e,r.startY=s,o.containerEl.appendChild(r.selectorDiv),r.addPoint((new Date).getTime(),e,s),r},connect:function(t,e,s,i,o,r){"use strict";var a=Math.sqrt((i-e)*(i-e)+(o-s)*(o-s)),n=(e+i)/2-a/2,l=(s+o)/2-r/2,h=Math.atan2(s-o,e-i)*(180/Math.PI);this.sketchpad.centerViewport?(t.style.left=this.sketchpad.width/2+n+"px",t.style.top=this.sketchpad.height/2+l+"px"):(t.style.left=n+"px",t.style.top=l+"px"),t.style.width=a+"px",t.style.transform="rotate("+h+"deg)",t.style.webkitTransform="rotate("+h+"deg)",t.style.MozTransform="rotate("+h+"deg)",t.style.msTransform="rotate("+h+"deg)",t.style.OTransform="rotate("+h+"deg)"},moveInput:function(t,e,s,i){"use strict";i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=t.startX,r=t.startY;if(i.shiftKey){var a=e-o,n=s-r,l=this.distance(o,r,e,s),h=Math.round(Math.atan2(a,n)/(Math.PI/4))*(Math.PI/4);e=o+l*Math.sin(h),s=r+l*Math.cos(h)}var c=o,d=r,p=e,u=s;this.connect(t.selectorDiv,c,d,p,u,this.getSize())},finishInput:function(t,e,s,i){"use strict";i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=this.sketchpad,r=t.startX,a=t.startY;if(i.shiftKey){var n=e-r,l=s-a,h=this.distance(r,a,e,s),c=Math.round(Math.atan2(n,l)/(Math.PI/4))*(Math.PI/4);e=r+h*Math.sin(c),s=a+h*Math.cos(c)}t.addPoint((new Date).getTime(),e,s),o.containerEl.removeChild(t.selectorDiv)},drawFramePath:function(t,e){"use strict";var s,i,o=t.cnf,r=this.sketchpad;if(o.lay&&o.lay.length)for(s=0;s<o.lay.length;s+=1){switch(o.lay[s]){case r.LAYER_BACK:i=r.contextB2D;break;case r.LAYER_FRONT:i=r.context2D;break;default:i=r.context2D}i.save(),i.rotate(r.rotation*Math.PI/180),i.scale(r.scale,r.scale),i.translate(t.vpx,t.vpy),i.translate(-r.viewportX,-r.viewportY),i.scale(1/t.scl,1/t.scl),i.rotate(-t.rot*Math.PI/180),i.beginPath(),i.lineCap="butt",i.lineJoin="round",i.strokeStyle=o.col,i.lineWidth=o.siz,i.moveTo(e.x[0],e.y[0]),i.lineTo(e.x[1],e.y[1]),i.stroke(),i.restore()}else console.warn("no layers to draw")}}),NSSketchpad.avaliableTools.push(ToolLine),ToolMandala.prototype=Object.create(Tool.prototype),Object.assign(ToolMandala.prototype,{layers:["F"],axis:7,color:{r:0,g:0,b:0,a:1},toolId:"mandala",toolLabel:"Mandala",lineWidth:1,keyCode:77,mirrorV:!1,mirrorH:!0,mirrorVH:!1,rainbow:!1,hideByDefault:!1,getToolConfig:function(){"use strict";var t=Tool.prototype.getToolConfig.call(this);return Object.assign(t,{axis:this.axis,mirrorV:this.mirrorV,mirrorH:this.mirrorH,mirrorVH:this.mirrorVH,rainbow:this.rainbow})},setToolConfig:function(t){"use strict";return Tool.prototype.setToolConfig.call(this,t),parseInt(t.axis,10)&&(this.axis=parseInt(t.axis,10)),this.mirrorV=t.mirrorV,this.mirrorH=t.mirrorH,this.mirrorVH=t.mirrorVH,this.rainbow=t.rainbow,this.dispatch("changeParams"),this},startInput:function(t,e,s,i){"use strict";i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=Tool.prototype.startInput.call(this,t,e,s);return o.mirrorV=this.mirrorV,o.mirrorH=this.mirrorH,o.mirrorVH=this.mirrorVH,o.rainbow=this.rainbow,o.axis=this.axis,o},getRbwColorStr:function(t,e){"use strict";var s={r:0,g:0,b:0,a:1};return s.r=Math.abs(Math.floor(255*Math.sin(t/50)))%255,s.g=Math.abs(Math.floor(255*Math.cos(e/50)))%255,s.b=Math.abs(Math.floor(255*Math.cos(t/50)))%255,"rgba("+s.r+","+s.g+","+s.b+","+s.a+")"},drawFramePath:function(i,t){"use strict";var e,s,o,r,a,n=i.cnf,l=this.sketchpad,h=n.axs;if(n.lay&&n.lay.length){var c=this;for(o=0;o<n.lay.length;o+=1){switch(n.lay[o]){case l.LAYER_BACK:e=l.contextB2D;break;case l.LAYER_FRONT:e=l.context2D;break;default:e=l.context2D}if(t&&t.x&&1<t.x.length)for(s=1;s<t.x.length;s+=1)for(r=0;r<h;r+=1)a=2*r*Math.PI/h,p(e,d(t.x[s-1],t.y[s-1],a,r),d(t.x[s],t.y[s],a,r)),n.mrh&&p(e,d(t.x[s-1],-t.y[s-1],a,r),d(t.x[s],-t.y[s],a,r)),n.mrv&&p(e,d(-t.x[s-1],t.y[s-1],a,r),d(-t.x[s],t.y[s],a,r)),n.mrvh&&p(e,d(-t.x[s-1],-t.y[s-1],a,r),d(-t.x[s],-t.y[s],a,r))}}else console.warn("no layers to draw");function d(t,e,s,i){return i%2==1&&(i=1),{x:Math.cos(s)*t-Math.sin(s)*e,y:Math.sin(s)*t+Math.cos(s)*e}}function p(t,e,s){t.save(),t.beginPath(),t.rotate(l.rotation*Math.PI/180),t.scale(l.scale,l.scale),t.translate(i.vpx,i.vpy),t.translate(-l.viewportX,-l.viewportY),t.scale(1/i.scl,1/i.scl),t.rotate(-i.rot*Math.PI/180),t.lineWidth=n.siz,n.rbw?t.strokeStyle=c.getRbwColorStr(e.x,e.y):t.strokeStyle=n.col,t.moveTo(e.x,e.y),t.lineTo(s.x,s.y),t.stroke(),t.restore()}}}),NSSketchpad.avaliableTools.push(ToolMandala),ToolMoveViewport.prototype=Object.create(Tool.prototype),Object.assign(ToolMoveViewport.prototype,{maxLayers:0,keyCode:32,toolLabel:"Move",toolId:"move-viewport",getCursor:function(){"use strict";return{pointer:"move",border:"none",borderRadius:0,backgroundColor:"rgba(0,0,0,0)"}},startInput:function(t,e,s,i){"use strict";i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=this.sketchpad,r=new Input({sketchpad:o,id:t,tool:this.toolId});return r.tmpCursor=this.sketchpad.containerEl.style.cursor,r.startX=e,r.startY=s,r.viewportX=this.sketchpad.viewportX,r.viewportY=this.sketchpad.viewportY,o.containerEl.style.cursor="move",o.hudsEl.style.opacity=0,r},moveInput:function(t,e,s,i){"use strict";i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o={x:(e-t.startX)*(1/this.sketchpad.scale),y:(s-t.startY)*(1/this.sketchpad.scale)},r=this.sketchpad;o=this.rotate(-r.rotation,o);var a=t.viewportX-o.x,n=t.viewportY-o.y;i&&i.shiftKey&&(a=10*Math.round(a/10),n=10*Math.round(n/10)),this.sketchpad.setViewportPosition(a,n)},finishInput:function(t,e,s,i){"use strict";i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10)),this.moveInput(t,e,s,i),this.sketchpad.containerEl.style.cursor=t.tmpCursor,this.sketchpad.hudsEl.style.opacity=1},drawFramePath:function(){}}),NSSketchpad.avaliableTools.push(ToolMoveViewport),ToolNull.prototype=Object.create(Tool.prototype),Object.assign(ToolNull.prototype,{maxLayers:0,keyCode:27,toolLabel:"Null",toolId:"null",startInput:function(t){"use strict";var e=this.sketchpad,s=new Input({sketchpad:e,id:t,tool:this.toolId});return s.tmpCursor=this.sketchpad.containerEl.style.cursor,e.containerEl.style.cursor="none",s},moveInput:function(){},finishInput:function(t){"use strict";this.sketchpad.containerEl.style.cursor=t.tmpCursor},drawFramePath:function(){}}),NSSketchpad.avaliableTools.push(ToolNull),ToolPen.prototype=Object.create(Tool.prototype),Object.assign(ToolPen.prototype,{color:{r:0,g:0,b:0,a:1},lineWidth:1,layers:["F"],keyCode:80,toolId:"pen",toolLabel:"Pen"}),NSSketchpad.avaliableTools.push(ToolPen),ToolRainbow.prototype=Object.create(Tool.prototype),Object.assign(ToolRainbow.prototype,{toolId:"rainbow",lineWidth:1,keyCode:66,toolLabel:"Rainbow",hideByDefault:!1,getCursor:function(){"use strict";var t=parseInt(this.getSize()+1,10);return{pointer:"crosshair",marginLeft:-(t+=10)/2+"px",marginTop:-t/2+"px",width:t+"px",height:t+"px",border:"1px solid black",boxSizing:"border-box",borderRadius:"50%",backgroundColor:"rgba(0,0,0,0)"}},getColorStr:function(t,e){"use strict";return this.color.r=Math.floor(256*Math.sin(t/50)),this.color.g=Math.floor(256*Math.cos(e/50)),this.color.b=Math.floor(256*Math.cos(t/50)),this.color.a=1,"rgba("+this.color.r+","+this.color.g+","+this.color.b+","+this.color.a+")"},drawFramePath:function(t,e){"use strict";var s,i,o,r,a,n=t.cnf,l=this.sketchpad;if(o=null,n.lay&&n.lay.length)for(i=0;i<n.lay.length;i+=1){switch(n.lay[i]){case l.LAYER_BACK:o=l.contextB2D;break;case l.LAYER_FRONT:o=l.context2D;break;default:o=l.context2D}if(o.save(),o.rotate(l.rotation*Math.PI/180),o.scale(l.scale,l.scale),o.translate(t.vpx,t.vpy),o.translate(-l.viewportX,-l.viewportY),o.scale(1/t.scl,1/t.scl),o.rotate(-t.rot*Math.PI/180),e&&e.x&&e.y&&1<e.x.length)for(s=1;s<e.x.length;s+=1)r={x:e.x[s-1],y:e.y[s-1]},a={x:e.x[s],y:e.y[s]},o.beginPath(),o.strokeStyle=this.getColorStr(r.x,r.y),o.lineCap="miter",o.lineJoin="miter",o.lineWidth=n.siz+100/(10+this.distance(r.x,r.y,a.x,a.y)),o.moveTo(r.x,r.y),o.lineTo(a.x,a.y),o.stroke();o.restore()}else console.warn("no layers to draw")}}),NSSketchpad.avaliableTools.push(ToolRainbow),ToolRect.prototype=Object.create(ToolFillable.prototype),Object.assign(ToolRect.prototype,{layers:["F"],toolLabel:"Rectangle",toolId:"rectangle",keyCode:82,lineWidth:1,color:{r:0,g:0,b:0,a:1},fillColor:{r:255,g:80,b:0,a:0},startInput:function(t,e,s,i){"use strict";i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=this.sketchpad,r=new Input({sketchpad:o,id:t,tool:this.toolId,color:this.getColorStr(),fillColor:this.getFillColorStr(),size:this.lineWidth,layers:this.layers});return r.firstX=e,r.firstY=s,r.selectorDiv=document.createElement("div"),r.selectorDiv.style.position="absolute",r.selectorDiv.style.border="1px solid black",r.selectorDiv.style.outline="1px dashed white",r.selectorDiv.style.outlineOffset="-1px",r.selectorDiv.style.display="block",this.sketchpad.centerViewport?(r.selectorDiv.style.left=this.sketchpad.width/2+e+"px",r.selectorDiv.style.top=this.sketchpad.height/2+s+"px"):(r.selectorDiv.style.left=e+"px",r.selectorDiv.style.top=s+"px"),r.selectorDiv.style.width="1px",r.selectorDiv.style.height="1px",o.containerEl.appendChild(r.selectorDiv),r.addPoint((new Date).getTime(),e,s),r},moveInput:function(t,e,s,i){"use strict";i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=t.firstX,r=t.firstY,a=Math.abs(s-r);i.shiftKey&&(e=e<o?o-a:o+a);var n=Math.min(o,e),l=Math.min(r,s),h=Math.max(o,e);a=Math.max(r,s)-l;var c=h-n;this.sketchpad.centerViewport?(t.selectorDiv.style.left=this.sketchpad.width/2+n-1+"px",t.selectorDiv.style.top=this.sketchpad.height/2+l-1+"px"):(t.selectorDiv.style.left=n+"px",t.selectorDiv.style.top=l+"px"),t.selectorDiv.style.width=c+"px",t.selectorDiv.style.height=a+"px"},finishInput:function(t,e,s,i){"use strict";i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=this.sketchpad,r=t.firstX,a=t.firstY,n=Math.abs(s-a);i.shiftKey&&(e=e<r?r-n:r+n),t.addPoint((new Date).getTime(),e,s),o.containerEl.removeChild(t.selectorDiv)},drawFramePath:function(t,e){"use strict";var s,i,o,r,a=t.cnf,n=this.sketchpad;if(a.lay&&a.lay.length)for(s=0;s<a.lay.length;s+=1){switch(a.lay[s]){case n.LAYER_BACK:i=n.contextB2D;break;case n.LAYER_FRONT:i=n.context2D;break;default:i=n.context2D}i.save(),i.beginPath(),i.strokeStyle=a.col,i.fillStyle=a.fcl,i.lineWidth=a.siz,i.rotate(n.rotation*Math.PI/180),i.scale(n.scale,n.scale),i.translate(t.vpx,t.vpy),i.translate(-n.viewportX,-n.viewportY),i.scale(1/t.scl,1/t.scl),i.rotate(-t.rot*Math.PI/180),o={x:e.x[0],y:e.y[0]},r={x:e.x[1],y:e.y[1]},i.rect(o.x,o.y,r.x-o.x,r.y-o.y),i.fill(),i.stroke(),i.restore()}else console.warn("no layers to draw")}}),NSSketchpad.avaliableTools.push(ToolRect),ToolRotateViewport.prototype=Object.create(Tool.prototype),Object.assign(ToolRotateViewport.prototype,{maxLayers:0,keyCode:32,toolLabel:"Rotate",toolId:"rotate-viewport",getCursor:function(){"use strict";return{pointer:"default",border:"none",borderRadius:"50%",backgroundColor:"rgba(0,0,0,0)"}},startInput:function(t,e,s){"use strict";var i=this.sketchpad,o=new Input({sketchpad:i,id:t,tool:this.toolId});return o.startRotation=i.rotation,o.startX=e,o.startY=s,o.viewportX=this.sketchpad.viewportX,o.viewportY=this.sketchpad.viewportY,i.hudsEl.style.opacity=0,o},moveInput:function(t,e,s,i){"use strict";var o=180*Math.atan2(e,s)/Math.PI-180*Math.atan2(t.startX,t.startY)/Math.PI;i.shiftKey&&(o=15*Math.round(o/15)),this.sketchpad.setRotation((-o+t.startRotation)%360)},finishInput:function(t){"use strict";this.sketchpad.hudsEl.style.opacity=1},drawFramePath:function(){}}),NSSketchpad.avaliableTools.push(ToolRotateViewport),ToolType.prototype=Object.create(Tool.prototype),Object.assign(ToolType.prototype,{toolLabel:"Text",toolId:"type",font:"Arial",keyCode:84,color:{r:0,g:0,b:0,a:1},size:14,getToolConfig:function(){"use strict";var t=Tool.prototype.getToolConfig.call(this);return Object.assign(t,{font:this.getFont(),size:this.getSize()})},setToolConfig:function(t){"use strict";return Tool.prototype.setToolConfig.call(this,t),parseFloat(t.size)&&this.setSize(parseFloat(t.size)),t.font&&this.setFont(t.font),this.dispatch("changeParams"),this},setSize:function(t){"use strict";return this.size=parseFloat(t),this.dispatch("changeParams"),this},getSize:function(){"use strict";return this.size},setFont:function(t){"use strict";return this.font=t,this.dispatch("changeParams"),this},getFont:function(){"use strict";return this.font},startInput:function(t,e,s,i){"use strict";i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=this.sketchpad,r=new Input({sketchpad:o,id:t,tool:this.toolId,color:this.getColorStr(),font:this.getFont(),size:this.getSize(),layers:this.layers});function a(){if(r.typeInput.written)return!1;r.typeInput.written=!0,r.addPoint((new Date).getTime(),r.x-1,r.y),r.addPoint((new Date).getTime(),r.x,r.y),r.textContent=r.typeInput.value,o.inputs[667]=r,o.sendInputs(),o.drawInputs(),delete o.inputs[667],o.containerEl.removeChild(r.typeInput)}return r.typeInput=document.createElement("input"),r.typeInput.value="enter text here",r.typeInput.placeholder="enter text here",r.typeInput.style.border=0,r.typeInput.style.boxShadow="none",r.typeInput.style.position="absolute",r.typeInput.style.outline="0",r.typeInput.style.overflow="hidden",r.typeInput.style.padding=0,r.typeInput.style.margin=0,r.typeInput.style.fontFamily=this.getFont(),r.typeInput.style.fontSize=this.getSize()+"px",r.typeInput.style.display="inline-block",r.typeInput.style.color=this.getColorStr(),r.typeInput.style.backgroundColor="rgba(255,255,255,0)",this.sketchpad.centerViewport?(r.typeInput.style.left=this.sketchpad.width/2+e-1+"px",r.typeInput.style.top=this.sketchpad.height/2+s-this.getSize()/2+"px"):(r.typeInput.style.left=e-1+"px",r.typeInput.style.top=s-this.getSize()/2+"px"),r.typeInput.style.width=1e4+"px",r.typeInput.style.height=this.getSize()+"px",r.typeInput.style.lineHeight=this.getSize()+"px",r.typeInput.addEventListener("blur",a),r.typeInput.addEventListener("change",a),r.typeInput.addEventListener("keyup",function(t){13===t.keyCode&&a(),27===t.keyCode&&(r.typeInput.value="",a())}),o.containerEl.appendChild(r.typeInput),r},moveInput:function(t,e,s,i){"use strict";i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10)),s-=this.getSize()/2,this.sketchpad.centerViewport?(t.typeInput.style.left=this.sketchpad.width/2+e+"px",t.typeInput.style.top=this.sketchpad.height/2+s+"px"):(t.typeInput.style.left=e+"px",t.typeInput.style.top=s+"px")},finishInput:function(t,e,s,i){"use strict";i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10)),t.x=e,t.y=s,t.typeInput.value="",t.typeInput.focus(),t.typeInput.select()},drawFramePath:function(t,e){"use strict";var s,i,o=t.cnf,r=this.sketchpad;if(o.lay&&o.lay.length)for(s=0;s<o.lay.length;s+=1){switch(o.lay[s]){case r.LAYER_BACK:i=r.contextB2D;break;case r.LAYER_FRONT:i=r.context2D;break;default:i=r.context2D}i.save(),i.rotate(r.rotation*Math.PI/180),i.scale(r.scale,r.scale),i.translate(t.vpx,t.vpy),i.translate(-r.viewportX,-r.viewportY),i.scale(1/t.scl,1/t.scl),i.rotate(-t.rot*Math.PI/180),i.font=o.siz+"px "+o.fnt,i.fillStyle=o.col,i.textAlign="left",i.textBaseline="middle",i.fillText(o.txt,e.x[0],e.y[0]),i.restore()}else console.warn("no layers to draw")}}),NSSketchpad.avaliableTools.push(ToolType),window.calculateOffsetXY=calculateOffsetXY,Sketchpad.prototype=Object.create(Eventsmanager.prototype),Object.assign(Sketchpad.prototype,{addSketchPage:function(s,i){"use strict";var o=this;s=Object.assign({sid:"asp"+Math.random()+"h"+(s&&s.backgroundPdf&&s.backgroundPdf.fingerprint)},s),this.sendMessageToServer({cmd:"page",config:s},!1,function(){var t=o.room.addSketch(o,s,"no_autoselect");o.room.setActiveSketch(o,t)}),this.on("sketch-added",function t(e){s.sid===e.getId()&&(o.removeListener("sketch-added",t),"function"==typeof i&&i(e,s))})},getToolsConfigs:function(){"use strict";var s,i={},o=this;return Object.keys(this.tools).forEach(function(t){var e=o.tools[t];s=e.getToolConfig(),i[s.toolId]=s}),i},setToolsConfigs:function(i){"use strict";var o=this;Object.keys(this.tools).forEach(function(t){var e=o.tools[t],s=i[t];e&&s&&e.setToolConfig(s)})},setMetaConfig:function(t,e){"use strict";return console.log("%cSET META CONFIG","background:green",t,e),!this.setMetaConfigFreeze&&(e&&(this.setMetaConfigFreeze=e),t=t||{},this.config=Object.assign(this.config,t),this.token=t.token||"#public",t.password&&(this.password=t.password||""),t.toolsConfigs&&this.setToolsConfigs(t.toolsConfigs),this.syncNetworkDataFrequency=t.syncNetworkDataFrequency||Math.round(1e3),this.centerViewport=!0,this.config.defaultTool&&this.getTool(this.config.defaultTool)&&this.setTool(this.config.defaultTool),this.displayGrid=this.config.features.displayGrid||!1,this.config.features.displayCrosshair?this.crosshairEl.style.display="block":this.crosshairEl.style.display="none",this.config.features.displayViewports?this.hudsEl.style.display="block":this.hudsEl.style.display="none",this.dispatch("setMetaConfig",t,this.setMetaConfigFreeze),this)},setSketchConfig:function(t){"use strict";t.viewportX=parseFloat(t.viewportX)||0,t.viewportY=parseFloat(t.viewportY)||0,this.setViewportPosition(t.viewportX,t.viewportY),t.viewportScale=parseFloat(t.viewportScale)||1,this.setScale(t.viewportScale),t.viewportZRotation=parseFloat(t.viewportZRotation)||0,this.setRotation(t.viewportZRotation);var e=this;return t.backgroundColor?(this.backgroundColor=t.backgroundColor,this.containerEl.style.backgroundColor=t.backgroundColor):(this.backgroundColor=!1,this.containerEl.style.backgroundColor="transparent"),t.width||(t.width=1400),t.height||(t.height=900),t.backgroundUrl?(this.backgroundUrl=t.backgroundUrl,this.backgroundIFrame.style.display="block",this.backgroundIFrame.width=t.width,this.backgroundIFrame.style.width=t.width+"px",this.backgroundIFrame.height=t.height,this.backgroundIFrame.style.height=t.height+"px",this.backgroundIFrame.src=t.backgroundUrl,this.backgroundIFrame.crossOrigin="anonymous"):(this.backgroundIFrame.src="about:blank",this.backgroundUrl=!1,this.backgroundIFrame.style.display="none"),t.backgroundImage?(this.backgroundImage=t.backgroundImage,this.background.style.display="none",this.background.onload=function(){e.background.style.display="block",console.log("ON LOAD!"),e.planRefreshWindow(0,"sketchpad.js:setSketchConfig:background.onload"),e.backgroundImageProgressbar.uploadComplete()},this.background.onerror=function(){e.backgroundImageProgressbar.cancel()},this.backgroundImageProgressbar&&!this.backgroundImageProgressbar.completed&&this.backgroundImageProgressbar.cancel(),this.background.onerror=function(){e.backgroundImageProgressbar.cancel()},this.backgroundImageProgressbar=new Progressbar({progressParentEl:this.progressParentEl}),this.backgroundImageProgressbar.startFakeProgress(),this.background.src=t.backgroundImage.toString(),this.background.crossOrigin="anonymous"):(this.background.src="",this.backgroundImage=!1,this.background.style.display="none"),t.foregroundImage?(this.foregroundImage=t.foregroundImage,this.foreground.style.display="none",this.foreground.onload=function(){e.foreground.style.display="block",e.planRefreshWindow(0,"sketchpad.js:setSketchConfig:foreground.onload"),e.foregroundImageProgressbar.uploadComplete()},this.foreground.onerror=function(){e.foregroundImageProgressbar.cancel()},this.foregroundImageProgressbar&&!this.foregroundImageProgressbar.completed&&this.foregroundImageProgressbar.cancel(),this.foregroundImageProgressbar=new Progressbar({progressParentEl:this.progressParentEl}),this.foregroundImageProgressbar.startFakeProgress(),this.foreground.src=t.foregroundImage.toString(),this.foreground.crossOrigin="anonymous"):(this.foreground.src="",this.foregroundImage=!1,this.foreground.style.display="none"),this.planRefreshWindow(0,"sketchpad.js:setSketchConfig"),this.dispatch("setPageConfig",t),this},getRoomConfig:function(){"use strict";var t={};return t.token=this.token,t.password=this.password,t.currentSketchSid=this.room.sketch&&this.room.sketch.getId()||"getRoomConfig-empty-sketch",t.toolsConfigs=this.getToolsConfigs(),t.defaultTool=this.tool,t.toolbar=this.config.toolbar,t.features=this.config.features,t},getSketchConfig:function(){"use strict";var t={};return t.viewportX=parseFloat(this.viewportX)||0,t.viewportY=parseFloat(this.viewportY)||0,t.viewportScale=parseFloat(this.scale)||1,t.viewportZRotation=parseFloat(this.rotation)||0,this.config.backgroundType&&(t.backgroundType=this.config.backgroundType),this.config.backgroundColorR&&(t.backgroundColorR=this.config.backgroundColorR),this.config.backgroundColorG&&(t.backgroundColorG=this.config.backgroundColorG),this.config.backgroundColorB&&(t.backgroundColorB=this.config.backgroundColorB),this.config.backgroundColorR&&(t.backgroundColorA=this.config.backgroundColorA),this.config.backgroundMapsLocation&&(t.backgroundMapsLocation=this.config.backgroundMapsLocation),this.config.backgroundPdf&&(t.backgroundPdf=this.config.backgroundPdf),this.config.backgroundMapsType&&(t.backgroundMapsType=this.config.backgroundMapsType),this.config.backgroundMapsZoom&&(t.backgroundMapsZoom=this.config.backgroundMapsZoom),this.backgroundColor&&(t.backgroundColor=this.backgroundColor),this.backgroundImage&&(t.backgroundImage=this.backgroundImage),this.backgroundUrl&&(t.backgroundUrl=this.backgroundUrl),this.foregroundImage&&(t.foregroundImage=this.foregroundImage),t},saveSketchpad:function(t){"use strict";var e,s=[],i=this.getRoomConfig();for(t||(i.password=""),s.push({hello:"Visit site www.sketchpad.pro to open this file.",site:"http://sketchpad.pro",description:"Sketchpad room file",cmd:"meta",config:i}),e=0;e<this.room.sketches.length;e+=1)s.push(this.room.sketches[e].getPageConfig(this)),s=s.concat(this.room.sketches[e].getFrames());return s},colorPicker:function(t,e){"use strict";var s=document.createElement("canvas");s.width=1,s.height=1;var i=s.getContext("2d");this.backgroundColor&&(i.fillStyle=this.backgroundColor,i.fillRect(0,0,s.width,s.height)),i.translate(-this.width/2-t,-this.height/2-e),this.background&&this.background.width&&(i.save(),i.translate(this.width/2,this.height/2),i.rotate(this.rotation*Math.PI/180),i.scale(this.scale,this.scale),i.translate(-this.viewportX,-this.viewportY),i.drawImage(this.background,-this.background.width/2,-this.background.height/2),i.restore()),i.drawImage(this.canvasB,0,0),i.drawImage(this.canvas,0,0),this.foreground&&this.foreground.width&&(i.save(),i.translate(this.width/2,this.height/2),i.rotate(this.rotation*Math.PI/180),i.scale(this.scale,this.scale),i.translate(-this.viewportX,-this.viewportY),i.drawImage(this.foreground,-this.foreground.width/2,-this.foreground.height/2),i.restore()),this.watermark&&i.drawImage(this.watermark,this.width-this.watermark.width,this.height-this.watermark.height);var o=i.getImageData(0,0,1,1).data;return{r:o[0],g:o[1],b:o[2],a:o[3]/255}},renderOutputCanvas:function(t){"use strict";var e=document.createElement("canvas"),s=this.viewportX,i=this.viewportY,o=this.width,r=this.height,a=this.rotation,n=this.scale;e.width=o,e.height=r;var l=e.getContext("2d");return t&&(this.backgroundColor&&"transparent"!==this.backgroundColor||(this.backgroundColor=t)),this.backgroundColor&&(l.fillStyle=this.backgroundColor,l.fillRect(0,0,e.width,e.height)),this.backgroundCanvas&&l.drawImage(this.backgroundCanvas,0,0),this.background&&this.background.width&&(l.save(),l.translate(o/2,r/2),l.rotate(a*Math.PI/180),l.scale(n,n),l.translate(-s,-i),l.drawImage(this.background,-this.background.width/2,-this.background.height/2),l.restore()),l.drawImage(this.canvasB,0,0),l.drawImage(this.canvas,0,0),this.foreground&&this.foreground.width&&(l.save(),l.translate(o/2,r/2),l.rotate(a*Math.PI/180),l.scale(n,n),l.translate(-s,-i),l.drawImage(this.foreground,-this.foreground.width/2,-this.foreground.height/2),l.restore()),this.watermark&&l.drawImage(this.watermark,o-this.watermark.width,r-this.watermark.height),e},screenshot:function(t,e,s){"use strict";return this.renderOutputCanvas().toBlob(t,e,s)},toDataURL:function(t,e){"use strict";var s=!1;return"image/jpeg"===e&&(s="white"),this.renderOutputCanvas(s).toDataURL(t,e)},showGrid:function(t){"use strict";var r=this.contextProjector2D;if(!r)return!1;var s=this;this.displayGrid=!0;var e,i,o=(t=t||{}).step||100,a=t.substep||10;function n(t,e,s,i,o){r.beginPath(),r.strokeStyle=o,r.moveTo(t,e),r.lineTo(s,i),r.stroke()}function l(t,e){n(0,t,s.width,t,e)}function h(t,e){n(t,0,t,s.height,e)}for(r.save(),l(this.height/2,"rgba(0,0,0,0.1)"),h(this.width/2,"rgba(0,0,0,0.1)"),e=this.width/2;e<=this.width;e+=o)h(e,"rgba(255,0,0,0.2)");for(e=this.width/2;0<e;e-=o)h(e,"rgba(255,0,0,0.2)");for(e=this.width/2;e<=this.width;e+=a)h(e,"rgba(255,0,0,0.1)");for(e=this.width/2;0<e;e-=a)h(e,"rgba(255,0,0,0.1)");for(i=this.height/2;i<=this.height;i+=o)l(i,"rgba(255,0,0,0.2)");for(i=this.height/2;0<i;i-=o)l(i,"rgba(255,0,0,0.2)");for(i=this.height/2;i<=this.height;i+=a)l(i,"rgba(255,0,0,0.1)");for(i=this.height/2;0<i;i-=a)l(i,"rgba(255,0,0,0.1)");r.restore()},hideGrid:function(){"use strict";this.displayGrid=!1,this.contextProjector2D.clearRect(0,0,this.width,this.height)},clearSketchpad:function(){"use strict";var t,e,s,i;this.windowWidth=this.containerEl.clientWidth,this.windowHeight=this.containerEl.clientHeight,this.backgroundCanvas.width=this.windowWidth,this.backgroundCanvas.height=this.windowHeight,this.canvas.width=this.windowWidth,this.canvas.height=this.windowHeight,this.width=this.canvas.width,this.height=this.canvas.height,this.canvasB.width=this.windowWidth,this.canvasB.height=this.windowHeight,this.canvasProjector.width=this.windowWidth,this.canvasProjector.height=this.windowHeight,this.context2D=this.canvas.getContext("2d"),this.contextB2D=this.canvasB.getContext("2d"),this.contextProjector2D=this.canvasProjector.getContext("2d"),this.context2D.lineCap="round",this.context2D.lineJoin="round",this.contextB2D.lineCap="round",this.contextProjector2D.lineJoin="round",this.contextProjector2D.lineCap="round",this.contextProjector2D.lineJoin="round",this.objectsCanva.innerHTML="",this.context2D.setTransform(1,0,0,1,0,0),this.contextB2D.clearRect(0,0,this.width,this.height),this.centerViewport&&(this.context2D.translate(this.width/2,this.height/2),this.contextB2D.translate(this.width/2,this.height/2)),this.displayGrid&&this.showGrid(),this.backgroundIFrame&&(this.centerViewport?(t=this.width/2-this.backgroundIFrame.width/2,e=this.height/2-this.backgroundIFrame.height/2,s=this.width/2,i=this.height/2,this.backgroundIFrame.style.transformOrigin=s+"px "+i+"px",this.backgroundIFrame.style.webkitTransformOrigin=s+"px "+i+"px",this.backgroundIFrame.style.MozTransformOrigin=s+"px "+i+"px",this.backgroundIFrame.style.msTransformOrigin=s+"px "+i+"px",this.backgroundIFrame.style.OTransformOrigin=s+"px "+i+"px",this.backgroundIFrame.style.transform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.backgroundIFrame.style.webkitTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.backgroundIFrame.style.MozTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.backgroundIFrame.style.msTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.backgroundIFrame.style.OTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)"):(this.backgroundIFrame.style.transform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.backgroundIFrame.style.webkitTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.backgroundIFrame.style.MozTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.backgroundIFrame.style.msTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.backgroundIFrame.style.OTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")")),this.background&&(this.centerViewport?(t=this.width/2-this.background.width/2,e=this.height/2-this.background.height/2,s=this.width/2,i=this.height/2,this.background.style.transformOrigin=s+"px "+i+"px",this.background.style.webkitTransformOrigin=s+"px "+i+"px",this.background.style.MozTransformOrigin=s+"px "+i+"px",this.background.style.msTransformOrigin=s+"px "+i+"px",this.background.style.OTransformOrigin=s+"px "+i+"px",this.background.style.transform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.background.style.webkitTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.background.style.MozTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.background.style.msTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.background.style.OTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)"):(this.background.style.transform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.background.style.webkitTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.background.style.MozTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.background.style.msTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.background.style.OTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")")),this.foreground&&(this.centerViewport?(t=this.width/2-this.foreground.width/2,e=this.height/2-this.foreground.height/2,s=this.width/2,i=this.height/2,this.foreground.style.transformOrigin=s+"px "+i+"px",this.foreground.style.webkitTransformOrigin=s+"px "+i+"px",this.foreground.style.MozTransformOrigin=s+"px "+i+"px",this.foreground.style.msTransformOrigin=s+"px "+i+"px",this.foreground.style.OTransformOrigin=s+"px "+i+"px",this.foreground.style.transform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.foreground.style.webkitTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.foreground.style.MozTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.foreground.style.msTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.foreground.style.OTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)"):(this.foreground.style.transform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.foreground.style.webkitTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.foreground.style.MozTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.foreground.style.msTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.foreground.style.OTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")")),this.hudsEl.style.transformOrigin=this.width/2+"px "+this.height/2+"px",this.hudsEl.style.webkitTransformOrigin=this.width/2+"px "+this.height/2+"px",this.hudsEl.style.MozTransformOrigin=this.width/2+"px "+this.height/2+"px",this.hudsEl.style.msTransformOrigin=this.width/2+"px "+this.height/2+"px",this.hudsEl.style.OTransformOrigin=this.width/2+"px "+this.height/2+"px",this.hudsEl.style.transform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px)",this.hudsEl.style.webkitTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px)",this.hudsEl.style.MozTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px)",this.hudsEl.style.msTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px)",this.hudsEl.style.OTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px)"},refreshWindow:function(t){"use strict";if(this.initialised&&!this.receivingHistory){this.sendInputs(),this.drawInputs();var o=this,r=String(Date.now()),a=this.room.sketch;this.postponeDrawingVersion=r;var n=100;if(this.room&&this.room.sketch instanceof Sketch)1024<this.room.sketch.framesHistory.length?(this.loadingEl.style.display="flex",this.loadingEl.textContent="..."):this.loadingEl.style.display="none",o.clearSketchpad(),!function t(e,s){if(r===o.postponeDrawingVersion&&a===o.room.sketch){var i;for(i=s;i<e.length&&i<s+n;i+=1)o.drawSketchFrame(e[i].evs,o.room.sketch);i<e.length&&setTimeout(function(){t(e,i)},0)}}(o.room.sketch.getCommandsHist(),0),o.loadingEl.style.display="none",o.dispatch("changeViewport"),o.dispatch("refreshWindow")}},planRefreshWindow:function(t,e){"use strict";t=parseInt(t)||0,this.planRefreshWindowTo&&clearTimeout(this.planRefreshWindowTo);var s=this;this.planRefreshWindowTo=setTimeout(function(){s.refreshWindow(e)},t)},setViewportPosition:function(t,e,s){"use strict";t=parseFloat(t),e=parseFloat(e);var i={deltaX:t-this.viewportX,deltaY:e-this.viewportY};this.viewportX=t,this.viewportY=e;var o=this;return this.once("refreshWindow",function(){o.dispatch("setViewportPosition",i),s||o.sendCurrentViewport()},"setViewportPosition:sendCurrentViewport"),this.planRefreshWindow(0,"sketchpad.js:setViewportPosition"),this},moveViewportRelative:function(t,e){"use strict";var s=-this.rotation,i={x:t*(1/this.scale),y:e*(1/this.scale)};return s=2*Math.PI*(s/360),i={x:Math.cos(s)*i.x-Math.sin(s)*i.y,y:Math.sin(s)*i.x+Math.cos(s)*i.y},this.setViewportPosition(this.viewportX-i.x,this.viewportY-i.y),this},setScale:function(t){"use strict";return(t=parseFloat(t))||(t=1),this.scale=t,this.setViewportPosition(this.viewportX,this.viewportY),this},setRotation:function(t){"use strict";return(t%=360)<0&&(t+=360),this.rotation=t,this.setViewportPosition(this.viewportX,this.viewportY),this.dispatch("setRotation",{o:t}),this},registerTool:function(t,e,s){"use strict";"object"!=typeof s&&(s={}),s.toolId=t,s.sketchpad=this;var i=new e(s);this.tools[i.toolId]=i;var o=this;i.on("changeParams",function(){this===o.getCurrentTool()&&o.user&&o.user.user_id&&o.projectPointer(o.pointerX,o.pointerY)}),this.config&&this.config.registerToolCb&&"function"==typeof this.config.registerToolCb&&this.config.registerToolCb(i)},getCurrentTool:function(){"use strict";return this.getTool(this.tool)},getCurrentToolId:function(){"use strict";return this.tool},getTool:function(t){"use strict";return t?this.tools[t]:this.getCurrentTool()},drawSketchNewFrames:function(){"use strict";if(this.room.sketch instanceof Sketch&&this.room){var t,e=this.room.sketch.getCommandsCurrent();for(t=0;t<e.length;t+=1)this.drawSketchFrame(e[t].evs,this.room.sketch)}},reset:function(t){"use strict";if(this.room.reset(),!t){var e={cmd:"reset",ts:(new Date).getTime()};this.sendMessageToServer(e)}this.dispatch("reset"),this.planRefreshWindow(0,"sketchpad.js:reset")},canDraw:function(){"use strict";return!this.readOnly},clearCanvas:function(){"use strict";this.inputs={},this.context2D.clearRect(0,0,this.canvas.width,this.canvas.height),this.contextB2D.clearRect(0,0,this.canvas.width,this.canvas.height)},setTool:function(t,e){"use strict";if(this.getTool(t)){var s=this.tool!==t,i=this.tool;return this.tool=t,this.dispatch("setTool",{hasChanged:s,lastToolId:i,tool:this.getTool(t),extra:e}),this}},drawFramePath:function(t,e){"use strict";if(this.drawingPaused)this.pausedQueue.push({config:t,points:e});else if(0<e.x.length){var s=this.getTool(t.tol);s?s.drawFramePath(t,e):console.warn("sketchpad.js","Unknown tool",t)}},drawFrame:function(t){"use strict";var e;for(e=0;e<t.length;e+=1)this.drawFramePath(t[e],t[e].pts)},pauseDrawing:function(){"use strict";this.drawingPaused=!0},resumeDrawing:function(){"use strict";var t;this.drawingPaused=!1;var e=this.pausedQueue;for(this.pausedQueue=[],t=0;t<e.length;t+=1)this.drawFramePath(e[t].config,e[t].points)},drawInputs:function(){"use strict";var e,s,i,o=[],r=this;Object.keys(this.inputs).forEach(function(t){(e=r.inputs[t])&&(s=e.getPointsToDraw())&&((i={}).tol=e.tool,i.cnf=e.getConfig(),i.vpx=e.viewportX,i.vpy=e.viewportY,i.scl=e.scale,i.rot=e.rotation,i.wdh=e.width,i.hgt=e.height,i.pts=s,i.uid=e.UID,o.push(i))}),0<o.length&&this.drawFrame(o)},drawSketchFrame:function(t,e){"use strict";var s,i;for(s=0;s<t.length;s+=1)void 0!==t[s].cid&&(i=e.getCachedFrame(t[s].cid)),this.drawFramePath(i,t[s].pts)},startPath:function(t,e,s,i){"use strict";if(this.inputs[e])return!1;var o=this.getCurrentToolId(),r=this.getTool(o).startInput(e,s,i,t);this.inputs[e]=r,this.dispatch("startPath",r)},drawPath:function(t,e,s,i){"use strict";if(!this.inputs[e])return!1;this.getTool(this.inputs[e].tool).moveInput(this.inputs[e],s,i,t)},endPath:function(t,e,s,i){"use strict";if(!this.inputs[e])return!1;this.getTool(this.inputs[e].tool).finishInput(this.inputs[e],s,i,t),this.sendInputs(),this.drawInputs(),delete this.inputs[e]},syncCanvasFrame:function(){"use strict";var t=this;this.windowWidth===this.containerEl.clientWidth&&this.windowHeight===this.containerEl.clientHeight||(this.windowWidth=this.containerEl.clientWidth,this.windowHeight=this.containerEl.clientHeight,this.once("refreshWindow",function(){t.sendCurrentViewport()},"syncCanvasFrame:sendCurrentViewport:(resize)"),this.planRefreshWindow(1e3,"room.js:syncCanvasFrame:(resize)")),this.receivingHistory&&(this.loadingEl.textContent=this.receivingHistoryInputsLoaded+"/"+this.receivingHistoryInputsTotal),window.requestAnimationFrame(function(){t.syncCanvasFrame()}),this.drawSketchNewFrames(),this.drawInputs()},mainPos:function(t,e){"use strict";var s=calculateOffsetXY(this.containerEl,t,e);return this.centerViewport&&(s.x=s.x-this.width/2,s.y=s.y-this.height/2),s},projectPointer:function(t,e){"use strict";var s=this.getTool().getCursor(),i=this.pointerEl;this.pointerEl.style.display="block",s&&s.pointer&&(this.containerEl.style.cursor=s.pointer),this.containerEl.style.cursor=s.pointer,Object.assign(i.style,s),i.style.position="absolute",i.style.left=t+"px",i.style.top=e+"px"},pointerMove:function(t,e){"use strict";this.pointerX=parseInt(t+this.width/2,10),this.pointerY=parseInt(e+this.height/2,10),this.projectPointer(this.pointerX,this.pointerY)},createEventsDraw:function(){"use strict";var t=this.containerEl,i=this;t.addEventListener("mousedown",function(t){if(i.inputEventsDisabled)return!1;t.preventDefault(),i.mouseLB=!0;var e=i.mainPos(t.clientX,t.clientY);i.startPath(t,0,e.x,e.y)},!1),t.addEventListener("mousemove",function(t){if(i.inputEventsDisabled)return!1;var e=i.mainPos(t.clientX,t.clientY);i.pointerMove(e.x,e.y),t.preventDefault(),i.mouseLB&&i.drawPath(t,0,e.x,e.y)},!1),t.addEventListener("mouseup",function(t){if(i.inputEventsDisabled)return!1;t.preventDefault(),i.mouseLB=!1;var e=i.mainPos(t.clientX,t.clientY);i.endPath(t,0,e.x,e.y)},!1),t.addEventListener("touchstart",function(t){if(i.inputEventsDisabled)return!1;var e,s;for(t.preventDefault(),e=0;e<t.changedTouches.length;e+=1)s=i.mainPos(t.changedTouches[e].clientX,t.changedTouches[e].clientY),i.startPath(t,t.changedTouches[e].identifier+10,s.x,s.y)},!1),t.addEventListener("touchmove",function(t){if(i.inputEventsDisabled)return!1;var e,s;for(t.preventDefault(),e=0;e<t.changedTouches.length;e+=1)s=i.mainPos(t.changedTouches[e].clientX,t.changedTouches[e].clientY),i.drawPath(t,t.changedTouches[e].identifier+10,s.x,s.y)},!1),t.addEventListener("touchend",function(t){if(i.inputEventsDisabled)return!1;var e,s;for(t.preventDefault(),e=0;e<t.changedTouches.length;e+=1)s=i.mainPos(t.changedTouches[e].clientX,t.changedTouches[e].clientY),i.endPath(t,t.changedTouches[e].identifier+10,s.x,s.y)},!1)},disableInputEvents:function(){"use strict";this.inputEventsDisabled=!0},enableInputEvents:function(){"use strict";this.inputEventsDisabled=!1},openConnection:function(t,e){"use strict";console.info("sketchpad.js","[info] openConnection",e)},getCurrentViewport:function(){"use strict";return{sid:this.room.sketch&&this.room.sketch.getId()||"getCurrentViewport-init",x:this.viewportX,y:this.viewportY,width:this.width,height:this.height,scale:this.scale,rotation:this.rotation,away:this.away}},sendCurrentViewport:function(){"use strict";if(this.room.sketch instanceof Sketch){var t={cmd:"update-viewport",user:{user_id:this.user&&this.user.user_id||this.UID,color:this.COLOR,viewport:this.getCurrentViewport()}};this.sendMessageToServer(t),this.room.updateClient(t.user),this.dispatch("updateClient",t.user)}},undo:function(){"use strict";this.room.sketch.undo(this)},redo:function(){"use strict";this.room.sketch.redo(this)},sendStringToServer:function(e,t,s){"use strict";if(1!==this.ws.readyState)return"function"==typeof s&&s("offline"),"ignore";try{this.ws.send(e),"function"==typeof t&&t()}catch(t){console.error("Error sending ws message",t,e),"function"==typeof s&&s(t)}},sendMessageToServer:function(t,e,s){"use strict";var i=JSON.stringify(t);return this.sendStringToServer(i,e,s)},executeInputCommand:function(t){"use strict";var e,s;switch(t.cmd){case"ping":this.sendMessageToServer({cmd:"pong",requestNo:t.no,requestTs:t.ts});break;case"goto":t.position&&(t.position.pageNo&&(e=this.room.getSketchByNo(t.position.pageNo))&&this.room.setActiveSketch(this,e),void 0!==t.position.x&&void 0!==t.position.y&&this.setViewportPosition(t.position.x,t.position.y),t.position.scale&&this.setScale(t.position.scale),t.position.rotation&&this.setRotation(t.position.rotation));break;case"room-status":this.editorsCount=t.editorsCount,this.viewersCount=t.viewersCount,this.dispatch("changeRoomStatus");break;case"set-permissions":t.permissions?(this.readOnly=!t.permissions.canDraw,this.dispatch("set-permissions",t.permissions)):console.error("Received not valid permissions in set-permission response");break;case"meta":t.config?this.setMetaConfig(t.config,"freeze"):console.error("Received not valid config in meta response");break;case"page":t.config?e=this.room.setPageConfig(this,t.config):console.error("Received not valid page config in page response");break;case"remove-page":t.sid&&(e=this.room.getSketchBySid(t.sid)),e instanceof Sketch?this.room.removeSketch(this,e,"remoteRemove"):console.warn("cannot remove sketch by input sid","[",t.sid,"]");break;case"clear-page":t.sid&&(e=this.room.getSketchBySid(t.sid)),e instanceof Sketch?(e.reset(this,e,"remoteClear"),this.dispatch("sketch-cleared",e),this.planRefreshWindow(0,"sketchpad.js:executeInputCommand:clear-page")):console.warn("cannot clear sketch by input sid","[",t.sid,"]");break;case"history-begin":this.receivingHistory=!0,this.loadingEl.style.display="flex",this.receivingHistoryInputsTotal=t.inputsCount||t.messagesCount||"?",this.receivingHistoryInputsLoaded=0,this.loadingEl.textContent=this.receivingHistoryInputsLoaded+"/"+this.receivingHistoryInputsTotal;break;case"netspeed-begin":this.room.sketch.grindingThreshold=1e3;break;case"inputs":t.sid&&(e=this.room.getSketchBySid(t.sid)),e instanceof Sketch||(console.warn("cannot find sketch by input sid, creating new sketch","[",t.sid,"]"),e=this.room.addSketch(this,Object.assign(this.getSketchConfig(),{sid:t.sid}),"remoteSketch"),this.room.sketch||this.room.setActiveSketch(this,e)),this.receivingHistory&&(this.receivingHistoryInputsLoaded+=1),e!==this.room.sketch&&(s=this.receivingHistory,this.receivingHistory=!0),e.grindBulkFrame(this,t,this.receivingHistory),e!==this.room.sketch&&(this.receivingHistory=s);break;case"history-end":this.receivingHistory=!1,this.loadingEl.style.display="none",this.planRefreshWindow(0,"sketchpad.js:executeInputCommand:history-end");break;case"netspeed-end":this.room.sketch.grindingThreshold=1e3/60;break;case"init-begin":this.initialised=!1;break;case"init-end":this.initialised=!0,this.config.currentPageNo||(this.config.currentPageNo=1),(e=this.room.getSketchByNo(this.config.currentPageNo))||(this.config.currentPageNo=1,e=this.room.getSketchByNo(this.config.currentPageNo)),e&&this.room.setActiveSketch(this,e),this.dispatch("initialised");break;case"reset":this.reset("remote");break;case"user-hello":t.user&&t.user.user_id&&t.user.viewport?(t.user.user_id=String(t.user.user_id),this.room.addClient(t.user),this.dispatch("addClient",t.user)):console.error("dropping user-hello, wrong  ``user || user.user_id``");break;case"pointer-move":t.user_id?this.room.setViewportPointer(t.user_id,t.x,t.y):console.error("dropping pointer-move, wrong ``user_id``");break;case"update-viewport":t.user&&t.user.user_id&&t.user.viewport?(t.user.user_id=String(t.user.user_id),this.room.updateClient(t.user),this.dispatch("updateClient",t.user)):console.error("dropping user-viewport, wrong  ``user || user.user_id``");break;case"user-bye":t.user&&t.user.user_id?(t.user.user_id=String(t.user.user_id),this.room.removeClientById(t.user.user_id),this.dispatch("removeClient",t.user)):console.error("dropping user-bye, wrong  ``user || user.user_id``");break;case"undo":t&&t.uid&&t.sid&&((e=this.room.getSketchBySid(t.sid))instanceof Sketch?e.undoSketch(this,t.uid):console.error("sketch not exists",t.sid,t),e===this.room.sketch&&this.planRefreshWindow(0,"sketchpad.js:executeInputCommand:undo"));break;case"you":t&&t.user&&(this.user=t.user,this.dispatch("identify",t.user));break;default:this.dispatch("customMessageFromServer",t)}},receiveMessageFromServer:function(t){"use strict";var e=JSON.parse(t.data),s=this;e&&setTimeout(function(){s.executeInputCommand(e)},0)},sendInputs:function(){"use strict";if(this.room&&this.room.sketch){var e,s,i,o={cmd:"inputs",sid:this.room.sketch.getId(),ts:(new Date).getTime(),uid:this.UID,evs:[]},r=this;if(Object.keys(this.inputs).forEach(function(t){(s=r.inputs[t])&&666!==t&&(i=s.getPointsToSend())&&((e={}).tol=s.tool,e.cnf=s.getConfig(),e.vpx=s.viewportX,e.vpy=s.viewportY,e.scl=s.scale,e.rot=s.rotation,e.wdh=s.width,e.hgt=s.height,e.pts=i,e.uid=s.UID,o.evs.push(e))}),0<o.evs.length)this.sendMessageToServer(o),this.room.sketch.grindBulkFrame(this,o,!0)}},syncNetworkData:function(){"use strict";this.syncNetworkDataTimeout&&clearTimeout(this.syncNetworkDataTimeout),this.syncNetworkDataTimeout=0;var t=this;this.syncNetworkDataTimeout=setTimeout(function(){t.syncNetworkData()},this.syncNetworkDataFrequency),this.sendInputs()}});